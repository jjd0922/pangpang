<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.BomMapper">
    <sql id="includeBomDatatable">
        <if test="pCode != null and pCode !=''">AND P_IDX LIKE CONCAT('%',#{pCode},'%')</if>
        <if test="pName != null and pName !=''">AND P_NAME LIKE CONCAT('%',#{pName},'%')</if>
    </sql>
    <select id="selectBomDatatable" resultType="map">
        SELECT
            BOM_P_IDX,
            P_NAME,
            CNT,
            (CASE
                WHEN CATE_DEPTH = 1 THEN CATE_NAME1
                WHEN CATE_DEPTH = 2 THEN CATE_NAME2
                WHEN CATE_DEPTH = 3 THEN CATE_NAME3
            END) CATE_NAME1,
            (CASE
                WHEN CATE_DEPTH = 2 THEN CATE_NAME1
                WHEN CATE_DEPTH = 3 THEN CATE_NAME2
            END)CATE_NAME2,
            IF (CATE_DEPTH = 3, CATE_NAME1, NULL) CATE_NAME3
        FROM
            PRODUCT
                LEFT JOIN (SELECT
                               CATEGORY1.CATE_IDX AS CATE_IDX,
                               CATEGORY1.CATE_DEPTH AS CATE_DEPTH,
                               CATEGORY1.CATE_NAME AS CATE_NAME1,
                               CATEGORY2.CATE_NAME AS CATE_NAME2,
                               CATEGORY3.CATE_NAME AS CATE_NAME3
                           FROM
                               CATEGORY AS CATEGORY1
                                   LEFT JOIN CATEGORY AS CATEGORY2
                                             ON CATEGORY1.CATE_PARENT_IDX = CATEGORY2.CATE_IDX
                                   LEFT JOIN CATEGORY AS CATEGORY3
                                             ON CATEGORY2.CATE_PARENT_IDX = CATEGORY3.CATE_IDX) DT ON DT.CATE_IDX = P_CATE_IDX
                JOIN (SELECT
                          BOM_P_IDX,
                          COUNT(BOM_P_IDX2) CNT
                      FROM
                          BOM
                      GROUP BY
                          BOM_P_IDX) B ON BOM_P_IDX = P_IDX
        <where>
            <include refid="includeBomDatatable"></include>
        </where>
        <if test="length!=-1">
            LIMIT #{start},#{length}
        </if>
    </select>

    <select id="countBomDatatable" resultType="Long">
        SELECT
            COUNT(DISTINCT(BOM_P_IDX))
        FROM
            BOM,
            PRODUCT
        WHERE
            BOM_P_IDX = P_IDX
            <include refid="includeBomDatatable"></include>
    </select>

    <insert id="insertBom">
        INSERT INTO
            BOM (BOM_P_IDX, BOM_P_IDX2)
        VALUES
            <foreach collection="cpIdx" separator="," item="item">
                (#{mpIdx}, #{item})
            </foreach>
    </insert>

    <select id="selectBomChild" resultType="map">
        SELECT
            P_IDX,
            P_NAME,
            P_COST
        FROM
            BOM,
            PRODUCT
        WHERE
            BOM_P_IDX = #{mpIdx}
            AND BOM_P_IDX2 = P_IDX
    </select>

    <delete id="deleteBom">
        DELETE FROM
                   BOM
        WHERE
            BOM_P_IDX = #{mpIdx}
    </delete>

    <delete id="deleteBomAll">
        DELETE FROM
            BOM
        WHERE
            <foreach collection="mpIdx" open="BOM_P_IDX IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
    </delete>

    <select id="countBom" resultType="int">
        SELECT
            COUNT(DISTINCT(BOM_P_IDX))
        FROM
            BOM
        WHERE
            BOM_P_IDX = #{mpIdx}
    </select>
</mapper>