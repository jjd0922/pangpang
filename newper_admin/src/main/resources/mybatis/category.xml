<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.CategoryMapper">

    <select id="selectCategoryDatatableByParent" resultType="map">
        SELECT
            P.*,
            if(C.CNT IS NULL,0,C.CNT) CNT
        FROM
            category P
                LEFT JOIN
            (
                SELECT
                    CATE_PARENT_IDX,COUNT(CATE_PARENT_IDX) CNT
                FROM
                    category
                where
                    CATE_PARENT_IDX is not null
                GROUP BY CATE_PARENT_IDX
            ) C
            ON P.CATE_IDX = C.CATE_PARENT_IDX
        WHERE
            P.CATE_PARENT_IDX IS NULL
            AND CATE_TYPE='CATEGORY'
        GROUP BY CATE_IDX
        order by CATE_ORDER
    </select>

    <select id="selectCategoryDatatableByChildren" resultType="map">
        SELECT
            P.*,
            if(C.CNT IS NULL,0,C.CNT) CNT
        FROM
            category P
                LEFT JOIN
            (
                SELECT
                    CATE_PARENT_IDX,COUNT(CATE_PARENT_IDX) CNT
                FROM
                    category
                where
                    CATE_PARENT_IDX is not null
                GROUP BY CATE_PARENT_IDX
            ) C
            ON P.CATE_IDX = C.CATE_PARENT_IDX
        WHERE
            P.CATE_PARENT_IDX = #{CATE_PARENT_IDX}
            AND CATE_TYPE='CATEGORY'
        GROUP BY CATE_IDX
        order by CATE_ORDER
    </select>


    <select id="selectCategory" resultType="Map">
        SELECT
            CATE_IDX,
            CATE_NAME
        FROM
            category
        WHERE
            CATE_IDX IS NOT NULL
            <if test="cateIdx != '' and cateIdx != null">and CATE_PARENT_IDX = #{cateIdx}</if>
            AND CATE_TYPE='CATEGORY'
    </select>
    
    <select id="maxCategoryOrderByCateDepth" resultType="Integer">
        SELECT
            MAX(CATE_ORDER)
        FROM
            category
        WHERE
            CATE_DEPTH=#{CATE_DEPTH}
            AND CATE_TYPE=#{CATE_TYPE}
    </select>

    <select id="selectCategoryListByCateDepth" resultType="map">
        SELECT
             PARENT.CATE_NAME PARENT_CATE_NAME
            ,CATEGORY.CATE_IDX
            ,CATEGORY.CATE_NAME
        FROM
            CATEGORY
                LEFT JOIN CATEGORY PARENT
                    ON CATEGORY.CATE_PARENT_IDX=PARENT.CATE_IDX
        WHERE
            CATEGORY.CATE_DEPTH=#{CATE_DEPTH}
            AND CATEGORY.CATE_TYPE='CATEGORY'
        ORDER BY PARENT.CATE_ORDER,CATEGORY.CATE_ORDER
    </select>

    <sql id="includeCategoryDatatableByBrand">
        <if test='CATE_NAME != null and CATE_NAME != ""'>AND CATE_NAME LIKE CONCAT('%',#{CATE_NAME},'%')</if>
        <!--<if test='CATE_DISPLAY != null and CATE_DISPLAY != ""'>AND CATE_DISPLAY = #{CATE_DISPLAY}</if>-->
        <if test='CREATED_BY != null and CREATED_BY != ""'>AND CREATED_BY LIKE CONCAT('%',#{CREATED_BY},'%')</if>
        <if test='CREATED_DATE != null and CREATED_DATE != ""'>AND CREATED_DATE BETWEEN SUBSTR(#{CREATED_DATE}, 1, 10) AND SUBSTR(#{CREATED_DATE}, 13)</if>
        <if test='MODIFIED_BY != null and MODIFIED_BY != ""'>AND MODIFIED_BY LIKE CONCAT('%',#{MODIFIED_BY},'%')</if>
        <if test='MODIFIED_DATE != null and MODIFIED_DATE != ""'>AND MODIFIED_DATE BETWEEN SUBSTR(#{MODIFIED_DATE}, 1, 10) AND SUBSTR(#{MODIFIED_DATE}, 13)</if>
    </sql>
    <select id="selectCategoryDatatableByBrand" resultType="map">
        select
            CATE_IDX, CATE_NAME, CATE_NICK, CATE_ICON, CREATED_BY,
            CREATED_DATE, MODIFIED_BY, MODIFIED_DATE, CATE_ORDER
        from
            category
        where
            CATE_TYPE='BRAND'
            <include refid="includeCategoryDatatableByBrand"></include>
        order by CATE_ORDER asc
        <if test="length!=-1">
            limit #{start},#{length}
        </if>
    </select>
    <select id="countCategoryDatatableByBrand" resultType="Integer">
        select
            count(*)
        from
            category
        where
            CATE_TYPE='BRAND'
            <include refid="includeCategoryDatatableByBrand"></include>
    </select>
</mapper>