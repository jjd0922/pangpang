<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.ChecksMapper">
    <select id="selectCheckGroupDatatable" parameterType="map" resultType="map">
        SELECT
            CHECK_GROUP.*
            ,SUM(CGS_EXPECTED_COST) CGS_EXPECTED_COST
            ,SUM(CGS_REAL_COST) CGS_REAL_COST
        FROM
            CHECK_GROUP, CHECK_GOODS
        WHERE
            CG_IDX = CGS_CG_IDX
        GROUP BY CG_IDX
        ORDER BY CG_IDX
        <if test="length!=-1">
            LIMIT #{start},#{length}
        </if>
    </select>
    <select id="countCheckGroupDatatable" parameterType="map" resultType="Long">
        SELECT COUNT(*) FROM CHECK_GROUP
    </select>

    <sql id="includeChecksDatatable">

    </sql>
    <select id="selectChecksDatatable"  parameterType="map" resultType="map">
        SELECT
            *
        FROM
            CHECKS, CHECK_GROUP,CHECK_GOODS
            ,GOODS
        WHERE
            CG_CHECK_IDX = CHECK_IDX
            AND CG_IDX = CGS_CG_IDX
            AND G_IDX = CGS_G_IDX


            <include refid="includeChecksDatatable"></include>
        <if test="length!=-1">
            limit #{start},#{length}
        </if>
    </select>
    <select id="countChecksDatatable"  parameterType="map" resultType="Long">
        SELECT
            COUNT(*)
        FROM
            CHECKS, CHECK_GROUP
        WHERE
            CG_CHECK_IDX = CHECK_IDX
            <include refid="includeChecksDatatable"></include>
    </select>

    <select id="selectCheckGroupExpectedCostTotal" resultType="Integer">
        SELECT
            SUM(CGS_COUNT * CGS_EXPECTED_COST)
        FROM
            CHECK_GOODS
        WHERE
            CGS_CG_IDX = #{cgIdx}
        GROUP BY
            CGS_CG_IDX
    </select>

    <sql id="includeCheckGoodsDataTable">
        <if test="cgIdx != '' and cgIdx != null">AND CG_IDX = #{cgIdx}</if>
        <if test="poIdx != '' and poIdx != null">AND PO_IDX = #{poIdx}</if>
        <if test="gState != '' and gState != null">AND G_STATE = #{gState}</if>
    </sql>
    <select id="selectCheckGoods" resultType="Map">
        SELECT
            *
        FROM
            CHECK_GOODS
                LEFT JOIN CHECK_GROUP ON CGS_CG_IDX = CG_IDX
                LEFT JOIN GOODS ON CGS_G_IDX = G_IDX
                LEFT JOIN PO ON G_PO_IDX = PO_IDX
                LEFT JOIN PRODUCT ON G_P_IDX = P_IDX
                LEFT JOIN CATEGORY ON P_CATE_IDX = CATE_IDX
        <where>
            <include refid="includeCheckGoodsDataTable"></include>
        </where>
    </select>

    <select id="selectCheckGroupGoods" resultType="Integer">
        SELECT
            COUNT(*)
        FROM
            CHECK_GOODS
                LEFT JOIN GOODS ON CGS_G_IDX = G_IDX
        WHERE
            CGS_CG_IDX = #{cgIdx}
        AND
            G_STATE != #{gState}
    </select>
</mapper>