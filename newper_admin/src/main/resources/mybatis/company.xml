<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.CompanyMapper">
    <sql id="includeCompanyDataTable">
        <if test='createdDate != null and createdDate != ""'>AND COMPANY.CREATED_DATE BETWEEN SUBSTR(#{createdDate}, 1, 10) AND SUBSTR(#{createdDate}, 13)</if>
        <if test='comName != null and comName != ""'>AND COM_NAME LIKE CONCAT('%',#{comName},'%')</if>
        <if test='comNum != null and comNum != ""'>AND COM_NUM LIKE CONCAT('%',#{comNum},'%')</if>
        <if test='comCeo != null and comCeo != ""'>AND COM_CEO LIKE CONCAT('%',#{comCeo},'%')</if>
        <if test='comMid != null and comMid != ""'>AND COM_MID LIKE CONCAT('%',#{comMid},'%')</if>
        <if test='comType != null'>
            <foreach collection="comType" open="AND COM_TYPE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test ='comState != null'>
            <foreach collection="comState" open="AND COM_STATE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
    </sql>

    <sql id="includeCompanyContractDataTable">
        AND CC_STATE = 'NORMAl'
        <if test='ccCreatedDate != null and ccCreatedDate != ""'>AND COMPANY_CONTRACT.CREATED_DATE BETWEEN SUBSTR(#{createdDate}, 1, 10) AND SUBSTR(#{createdDate}, 13)</if>
        <if test="ccTaxDate != null and ccTaxDate != ''">AND CC_TAX_DATE BETWEEN SUBSTR(#{ccTaxDate}, 1, 10) AND SUBSTR(#{ccTaxDate}, 13)</if>
        <if test="ccNum != null and ccNum != ''">AND CC_NUM LIKE CONCAT('%', #{ccNum}, '%')</if>
        <if test='ccCycle != null'>
            <foreach collection="ccCycle" open="AND CC_CYCLE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test='ccType != null'>
            <foreach collection="ccType" open="AND CC_TYPE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test='ccCalType != null'>
            <foreach collection="ccCalType" open="AND CC_CAL_TYPE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test='ccState != null'>
            <foreach collection="ccState" open="AND CC_STATE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
    </sql>

    <sql id="includeStoreDatatable">
        <if test="comName != null and comName != ''">AND COM_NAME LIKE CONCAT('%',#{comName},'%')</if>
        <if test="comMid != null and comMid != ''">AND COM_MID LIKE CONCAT('%',#{comMid},'%')</if>
        <if test="ceName != null and ceName != ''">AND CE_NAME LIKE CONCAT('%',#{ceName},'%')</if>
    </sql>

    <sql id="includeFeeDatatable">
        AND CATE_DEPTH = 2
        AND CF_STATE = 'Y'
        <if test="cateIdx != null">
            <foreach collection="cateIdx" open="AND CATE_IDX IN(" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="cfType != null">
            <foreach collection="cfType" open="AND CF_TYPE IN(" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
    </sql>

    <sql id="includeInsuranceDatatable">
        <if test="ciType != null">
            <foreach collection="ciType" open="AND CI_TYPE IN(" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="ciInsuranceState != null">
            <foreach collection="ciInsuranceState" open="AND CI_INSURANCE_STATE IN(" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="comName != null and comName != ''">AND COM_NAME LIKE CONCAT('%',#{comName},'%')</if>
        <if test="ciCompany != null and ciCompany != ''">AND CI_COMPANY LIKE CONCAT('%',#{ciCompany},'%')</if>
        <if test="ciName != null and ciName != ''">AND CI_NAME LIKE CONCAT('%',#{ciName},'%')</if>
        <if test="ciStartDate != null and ciStartDate != ''">AND CI_START_DATE BETWEEN SUBSTR(#{ciStartDate}, 1, 10) AND SUBSTR(#{ciStartDate}, 13)</if>
        <if test="ciEndDate != null and ciEndDate != ''">AND CI_END_DATE BETWEEN SUBSTR(#{ciEndDate}, 1, 10) AND SUBSTR(#{ciEndDate}, 13)</if>
        <if test="ciNum != null and ciNum != ''">AND CI_NUM LIKE CONCAT('%',#{ciNum},'%')</if>
        <if test="createdBy != null and createdBy != ''">AND CREATED_BY LIKE CONCAT('%',#{createdBy},'%')</if>
        <if test="createdDate != null and createdDate != ''">AND CREATED_DATE BETWEEN SUBSTR(#{createdDate}, 1, 10) AND SUBSTR(#{createdDate}, 13)</if>
    </sql>

    <select id="selectCompanyDatatable" resultType="Map" parameterType="Map">
        SELECT
            COM_IDX,
            COMPANY.CREATED_DATE AS 'COM_CREATED_DATE',
            COMPANY.CREATED_TIME AS 'COM_CREATED_TIME',
            GROUP_CONCAT(CT_TYPE) AS CT_TYPE_LIST,
            COM_TYPE,
            COM_STATE,
            COM_MID,
            COM_NAME,
            COM_CEO,
            POST,
            CONCAT(ADDR1,' ',ADDR2,' ',ADDR3,' ',ADDR4) AS ADDRESS,
            COM_TEL,
            COM_CE_IDX,
            CE_IDX,
            CE_NAME,
            CE_PHONE,
            COMPANY.CREATED_BY AS 'COM_CREATED_BY',
            COMPANY.MODIFIED_BY AS 'COM_MODIFIED_BY',
            COMPANY.MODIFIED_DATE AS 'COM_MODIFIED_DATE'
        FROM
            COMPANY
                LEFT JOIN COMPANY_EMPLOYEE ON COM_CE_IDX = CE_IDX
                LEFT JOIN COMPANY_TYPE ON CT_COM_IDX = COM_IDX
        <where>
            <include refid="includeCompanyDataTable"></include>
        </where>
        GROUP BY
            COM_IDX
                <if test="ctType != null">
                    <foreach collection="ctType" open="HAVING " separator="OR" item="item">
                        CT_TYPE_LIST LIKE CONCAT('%',#{item},'%')
                    </foreach>
                </if>
        ORDER BY
            COM_IDX DESC
        <if test="length!=-1">
            limit #{start},#{length}
        </if>
    </select>

    <select id="countCompanyDatatable" resultType="Long">
        SELECT
            COUNT(DISTINCT(COM_IDX))
        FROM
            COMPANY
                LEFT JOIN COMPANY_EMPLOYEE ON COM_CE_IDX = CE_IDX
                LEFT JOIN COMPANY_TYPE ON CT_COM_IDX = COM_IDX
        <where>
            <include refid="includeCompanyDataTable"></include>
            <if test="ctType != null">
                <foreach collection="ctType" open="AND CT_TYPE IN (" separator="," close=")" item="item">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <insert id="insertCompanyType">
        INSERT INTO
            COMPANY_TYPE (CT_COM_IDX, CT_TYPE)
        VALUES
            <foreach collection="ctType" separator="," item="item">
                (#{comIdx},#{item})
            </foreach>
    </insert>

    <select id="selectCompanyType" resultType="Map">
        SELECT
            CT_TYPE
        FROM
            COMPANY_TYPE
                JOIN COMPANY ON CT_COM_IDX = COM_IDX
        WHERE
            CT_COM_IDX = #{comIdx}
    </select>

    <select id="selectCompanyContract" resultType="Map">
        SELECT
            COM_IDX,
            CC_IDX,
            COM_NAME,
            COM_MID,
            CC_NAME,
            CC_TYPE,
            CC_STATE,
            CC_CYCLE,
            CC_TAX_DATE,
            CC_BASE_DATE,
            CC_START,
            CC_END,
            CC_FEE_TYPE,
            CC_COST,
            CC_RATES,
            CC_NUM,
            COMPANY_CONTRACT.CREATED_BY AS 'CC_CREATED_BY',
            COMPANY_CONTRACT.CREATED_DATE AS 'CC_CREATED_DATE',
            COMPANY_CONTRACT.MODIFIED_BY AS 'CC_MODIFIED_BY',
            COMPANY_CONTRACT.MODIFIED_DATE AS 'CC_MODIFIED_DATE'
        FROM
            COMPANY
                LEFT JOIN COMPANY_CONTRACT ON COM_IDX = CC_COM_IDX
        WHERE
            CC_IDX IS NOT NULL
            <include refid="includeCompanyDataTable"></include>
            <include refid="includeCompanyContractDataTable"></include>
        <if test="length!=-1">
            limit #{start},#{length}
        </if>
    </select>

    <select id="countCompanyContract" resultType="Long">
        SELECT
            COUNT(*)
        FROM
            COMPANY
              LEFT JOIN COMPANY_CONTRACT ON COM_IDX = CC_COM_IDX
        WHERE
            CC_IDX IS NOT NULL
            <include refid="includeCompanyDataTable"></include>
            <include refid="includeCompanyContractDataTable"></include>
    </select>

    <select id="selectStoreDatatable" resultType="Map">
        SELECT
            COM_IDX,
            U_IDX,
            COM_NAME,
            COM_MID,
            U_NAME,
            COMPANY.CREATED_BY AS 'COM_CREATED_BY',
            COMPANY.CREATED_DATE AS 'COM_CREATED_DATE',
            COMPANY.MODIFIED_BY AS 'COM_MODIFIED_BY',
            COMPANY.MODIFIED_DATE AS 'COM_MODIFIED_DATE'
        FROM
            COMPANY
                LEFT JOIN USER ON COM_U_IDX = U_IDX
                LEFT JOIN COMPANY_TYPE ON COM_IDX = CT_COM_IDX
        WHERE
            CT_TYPE = 'STORE'
            <include refid="includeStoreDatatable"></include>
        <if test="length!=-1">
            limit #{start},#{length}
        </if>
    </select>

    <select id="countStoreDatatable" resultType="Long">
        SELECT
            COUNT(DISTINCT(COM_IDX))
        FROM
            COMPANY
                LEFT JOIN USER ON COM_U_IDX = U_IDX
                LEFT JOIN COMPANY_TYPE ON COM_IDX = CT_COM_IDX
        WHERE
            CT_TYPE = 'STORE'
    </select>

    <select id="selectFeeDatatable" resultType="Map">
        SELECT
            CATE_NAME,
            CF_IDX,
            CF_TYPE,
            CF_PERCENT,
            CF_MONEY
        FROM
            COMPANY_FEE
                LEFT JOIN CATEGORY ON CF_CATE_IDX = CATE_IDX
                JOIN COMPANY ON CF_COM_IDX = COM_IDX
        WHERE
            CF_COM_IDX = #{comIdx}
            <include refid="includeFeeDatatable"></include>
        <if test="length!=-1">
            limit #{start},#{length}
        </if>
    </select>

    <select id="countFeeDatatable" resultType="Long">
        SELECT
            COUNT(DISTINCT(CF_IDX))
        FROM
            COMPANY_FEE
                JOIN CATEGORY ON CF_CATE_IDX = CATE_IDX
        WHERE
            CF_COM_IDX = #{comIdx}
            <include refid="includeFeeDatatable"></include>
    </select>

    <select id="selectInsuranceDatatable" resultType="Map">
        SELECT
            CI_TYPE,
            CI_INSURANCE_STATE,
            COM_NAME,
            CI_COMPANY,
            CI_IDX,
            CI_NAME,
            CI_START_DATE,
            CI_END_DATE,
            CI_NUM,
            CI_FEE,
            CI_PERCENT,
            CI_MONEY,
            CI.CREATED_BY AS CI_CREATED_BY,
            CI.CREATED_DATE AS CI_CREATED_DATE/*,
            CI.MODIFIED_BY AS MODIFIED_BY,
            CI.MODIFIED_DATE AS MODIFIED_DATE*/
        FROM
            COMPANY_INSURANCE AS CI
                LEFT JOIN COMPANY ON CI_COM_IDX = COM_IDX
        <where>
            <include refid="includeInsuranceDatatable"></include>
        </where>
        <if test="length!=-1">
            limit #{start},#{length}
        </if>
    </select>

    <select id="countInsuranceDatatable" resultType="Long">
        SELECT
            COUNT(DISTINCT(CI_IDX))
        FROM
            COMPANY_INSURANCE AS CI
                LEFT JOIN COMPANY ON CI_COM_IDX = COM_IDX
        <where>
            <include refid="includeInsuranceDatatable"></include>
        </where>
    </select>

    <sql id="includeCompanyDatatableByCtType">
        <if test='CREATED_DATE != null and CREATED_DATE != ""'>AND CREATED_DATE BETWEEN SUBSTR(#{CREATED_DATE}, 1, 10) AND SUBSTR(#{CREATED_DATE}, 13)</if>
        <if test='COM_NAME != null and COM_NAME != ""'>AND COM_NAME LIKE CONCAT('%',#{COM_NAME},'%')</if>
        <if test='COM_NUM != null and COM_NUM != ""'>AND COM_NUM LIKE CONCAT('%',#{COM_NUM},'%')</if>
        <if test='COM_NAME != null and COM_NAME != ""'>AND COM_NAME LIKE CONCAT('%',#{COM_NAME},'%')</if>
        <if test='COM_CEO != null and COM_CEO != ""'>AND COM_CEO LIKE CONCAT('%',#{COM_CEO},'%')</if>
        <if test='COM_MID != null and COM_MID != ""'>AND COM_MID LIKE CONCAT('%',#{COM_MID},'%')</if>
        <if test='COM_TYPE != null'>
            <foreach collection="COM_TYPE" open="AND COM_TYPE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test='COM_STATE != null'>
            <foreach collection="COM_STATE" open="AND COM_STATE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
    </sql>
    <select id="selectCompanyDatatableByCtType" resultType="map">
        SELECT
            COM_IDX,
            COM_NAME,
            COM_STATE,
            COM_TYPE,
            COM_MID,
            COM_CEO,
            COMPANY.CREATED_DATE AS 'COM_CREATED_DATE',
            COMPANY.CREATED_TIME AS 'COM_CREATED_TIME',
            CT_TYPE
        FROM
            COMPANY
                LEFT JOIN COMPANY_TYPE ON COM_IDX = CT_COM_IDX
        WHERE
            CT_TYPE = #{CT_TYPE}
            <include refid="includeCompanyDatatableByCtType"></include>
        <if test="length!=-1">
            limit #{start},#{length}
        </if>
    </select>
    <select id="countCompanyDatatableByCtType" resultType="Integer">
        select
            count(*)
        from
            COMPANY
                LEFT JOIN COMPANY_TYPE ON COM_IDX = CT_COM_IDX
        WHERE
            CT_TYPE = #{CT_TYPE}
            <include refid="includeCompanyDatatableByCtType"></include>
    </select>

</mapper>