<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.DeliveryMapper">
    <select id="selectDeliveryDatatable" resultType="map">

        SELECT
            OG_IDX, O_DATE, delivery_num.CREATED_DATE AS REQ_DATE, DN_RELEASE, DN_DATE,
            O_STATE, G_STATE, O_IDX, OG_DN_IDX,
            G_STOCK_STATE, O_CODE, SHOP_NAME, P_IDX, G_BARCODE,
            P_NAME, O_NAME, O_PHONE, AD_NAME, AD_PHONE,
            order_address.POST, CONCAT(order_address.ADDR1, ' ', order_address.ADDR2, ' ', order_address.ADDR3, ' ', order_address.ADDR4) AS ADDRS,
            WH_NAME, DN_COMPANY, DN_NUM, AD_MEMO
        FROM
            orders
                LEFT JOIN order_gs
                    ON OG_O_IDX=O_IDX
                LEFT JOIN shop_product_option
                    ON OG_SPO_IDX=SPO_IDX
                LEFT JOIN goods_stock
                    ON SPO_GS_IDX=GS_IDX
                LEFT JOIN delivery_num
                    ON OG_DN_IDX=DN_IDX
                LEFT JOIN product
                    ON GS_P_IDX=P_IDX
                LEFT JOIN payment
                    ON O_PAY_IDX=PAY_IDX
                LEFT JOIN shop_product_add
                    ON SPO_SPA_IDX=SPA_IDX
                LEFT JOIN shop_product
                    ON SPA_SP_IDX=SP_IDX
                LEFT JOIN goods
                    ON G_IDX=OG_G_IDX
                LEFT JOIN shop
                    ON O_SHOP_IDX=SHOP_IDX
                LEFT JOIN order_address
                    ON O_AD_IDX=AD_IDX
                LEFT JOIN location
                    ON G_LOC_IDX=LOC_IDX
                LEFT JOIN warehouse
                    ON LOC_WH_IDX=WH_IDX
        where
            P_DEL_TYPE=#{P_DEL_TYPE}
        <if test="length!=-1">
            limit #{start},#{length}
        </if>
    </select>

    <select id="countDeliveryDatatable" resultType="integer">
        SELECT
           COUNT(*)
        FROM
            orders
                LEFT JOIN order_gs
                          ON OG_O_IDX=O_IDX
                LEFT JOIN shop_product_option
                          ON OG_SPO_IDX=SPO_IDX
                LEFT JOIN goods_stock
                          ON SPO_GS_IDX=GS_IDX
                LEFT JOIN delivery_num
                          ON OG_DN_IDX=DN_IDX
                LEFT JOIN product
                          ON GS_P_IDX=P_IDX
                LEFT JOIN payment
                          ON O_PAY_IDX=PAY_IDX
                LEFT JOIN shop_product_add
                          ON SPO_SPA_IDX=SPA_IDX
                LEFT JOIN shop_product
                          ON SPA_SP_IDX=SP_IDX
                LEFT JOIN goods
                          ON G_IDX=OG_G_IDX
                LEFT JOIN shop
                          ON O_SHOP_IDX=SHOP_IDX
        where
            P_DEL_TYPE=#{P_DEL_TYPE}

    </select>

    <select id="selectDeliveryByGoods" resultType="Map">
        SELECT
            G_IDX,
            G_BARCODE,
            IF(AS_IDX IS NULL AND OGGC_IDX IS NULL, 0, DN_IDX) AS DN_IDX,
            IF(AS_IDX IS NULL AND OGGC_IDX IS NULL, '미확인', DN_NUM) AS DN_NUM
        FROM
            GOODS
                LEFT JOIN ORDER_GS ON G_IDX = OG_G_IDX
                LEFT JOIN ORDER_GS_DN ON OG_IDX = OGDN_OG_IDX
                LEFT JOIN DELIVERY_NUM ON OGDN_DN_IDX = DN_IDX
                LEFT JOIN AFTER_SERVICE ON DN_IDX = AS_DN_IDX
                LEFT JOIN ORDER_GS_GROUP_CANCEL ON OG_SPO_IDX = OGGC_SPO_IDX
        WHERE
            G_BARCODE = #{gBarcode}
        ORDER BY
            DN_IDX DESC
        LIMIT
            0, 1
    </select>
</mapper>
