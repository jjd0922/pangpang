<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.GiftMapper">
    <sql id="includeGiftGroupDataTable">
        <if test='giftgName != null and giftgName != ""'>AND GIFTG_NAME LIKE CONCAT('%',#{giftgName},'%')</if>
        <if test='giftgCode != null and giftgCode != ""'>AND GIFTG_CODE LIKE CONCAT('%',#{giftgCode},'%')</if>
        <if test='createdBy != null and createdBy != ""'>AND CREATED_BY LIKE CONCAT('%',#{createdBy},'%')</if>
        <if test='giftgStartDate != null and giftgStartDate != ""'>AND GIFTG_START_DATE BETWEEN SUBSTR(#{giftgStartDate}, 1, 10) AND SUBSTR(#{giftgStartDate}, 13)</if>
        <if test='giftgEndDate != null and giftgEndDate != ""'>AND GIFTG_END_DATE BETWEEN SUBSTR(#{giftgEndDate}, 1, 10) AND SUBSTR(#{giftgEndDate}, 13)</if>
        <if test='createdDate != null and createdDate != ""'>AND CREATED_DATE BETWEEN SUBSTR(#{createdDate}, 1, 10) AND SUBSTR(#{createdDate}, 13)</if>
        <if test="giftgState != null">
            <foreach collection="giftgState" open="AND GIFTG_STATE IN(" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
    </sql>

    <select id="selectGiftGroupDataTable" resultType="Map">
        SELECT
            GIFTG_IDX,
            GIFTG_NAME,
            GIFTG_STATE,
            GIFTG_START_DATE,
            GIFTG_END_DATE,
            GIFTG_CNT,
            /*상품권사용수량 CNT*/
            CREATED_BY,
            CREATED_DATE
        FROM
            GIFT_GROUP
        <where>
            <include refid="includeGiftGroupDataTable"></include>
        </where>
        <if test="length!=-1">
            LIMIT #{start},#{length}
        </if>
    </select>

    <select id="countGiftGroupDataTable" resultType="long">
        SELECT
            COUNT(*)
        FROM
            GIFT_GROUP
        <where>
            <include refid="includeGiftGroupDataTable"></include>
        </where>
    </select>

    <select id="selectGiftDataTable" resultType="Map">
        SELECT
            GIFT_IDX,
            GIFT_STATE,
            GIFT_CODE,
            POINT_CU_IDX,
            CU_NAME
        FROM GIFT
                LEFT JOIN GIFT_GROUP ON GIFT_GIFTG_IDX = GIFTG_IDX
                LEFT JOIN (
                    SELECT
                        POINT_IDX,
                        POINT_CU_IDX,
                        CU_NAME
                    FROM POINT_HISTORY
                        LEFT JOIN CUSTOMER ON POINT_CU_IDX = CU_IDX
                    ) AS PH ON GIFT_POINT_IDX = POINT_IDX
        WHERE
            GIFTG_IDX = #{giftgIdx}
        <if test="length!=-1">
            LIMIT #{start},#{length}
        </if>
    </select>

    <select id="countGiftDataTable" resultType="long">
        SELECT
            COUNT(DISTINCT(GIFT_IDX))
        FROM
            GIFT
                LEFT JOIN GIFT_GROUP ON GIFT_GIFTG_IDX = GIFTG_IDX
                LEFT JOIN POINT_HISTORY ON GIFT_POINT_IDX = POINT_IDX
        WHERE
            GIFTG_IDX = #{giftgIdx}
    </select>

    <insert id="insertGift">
        CALL
            INSERT_GIFT
                (#{giftgIdx}, #{giftgCnt}, #{giftState}, #{length});
    </insert>

    <select id="countGiftByGiftgIdx" resultType="int">
        SELECT
            COUNT(GIFT_CODE)
        FROM
            GIFT
        WHERE
            GIFT_GIFTG_IDX = #{giftgIdx}
    </select>

    <update id="disposeAllGift">
        UPDATE
            GIFT
        SET
            GIFT_STATE = #{giftState}
        WHERE
            <foreach collection="giftIdxList" open="(" separator="OR" close=")" item="item">
                GIFT_IDX = #{item}
            </foreach>
    </update>
</mapper>