<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.LocationMapper">
    <sql id="includeLocationDatatable">
        <if test="locType != null">
            <foreach collection="locType" open="AND LOC_TYPE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="locForm != null">
            <foreach collection="locForm" open="AND LOC_FORM IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="locCode != null and locCode != ''">AND LOC_CODE LIKE CONCAT('%',#{locCode},'%')</if>
        <if test="locZone != null and locZone != ''">AND LOC_ZONE LIKE CONCAT('%',#{locZone},'%')</if>
        <if test="locRow != null and locRow != ''">AND LOC_ROW LIKE CONCAT('%',#{locRow},'%')</if>
        <if test="locColumn != null and locColumn != ''">AND LOC_COLUMN LIKE CONCAT('%',#{locColumn},'%')</if>
        <if test="location != null and location != ''">AND CONCAT(LOC_ZONE,LOC_COLUMN,LOC_ROW) LIKE CONCAT('%',#{location},'%')</if>
        <if test="uName != null and uName != ''">AND U_NAME LIKE CONCAT('%',#{uName},'%')</if>
        <if test="whIdx != null and whIdx != ''">AND WH_IDX LIKE CONCAT('%',#{whIdx},'%')</if>
    </sql>

    <select id="selectLocationDatatable" resultType="map">
        SELECT
            LOC_IDX,
            WH_IDX,
            WH_NAME,
            LOC_TYPE,
            LOC_CODE,
            LOC_FORM,
            LOC_ZONE,
            LOC_COLUMN,
            LOC_ROW,
            LOC_BARCODE,
            U_NAME
        FROM
            LOCATION
                LEFT JOIN WAREHOUSE ON LOC_WH_IDX = WH_IDX
                LEFT JOIN USER ON LOC_U_IDX = U_IDX
        <where>
            <include refid="includeLocationDatatable"></include>
        </where>
        <if test="length != -1">
            LIMIT #{start},#{length}
        </if>
    </select>
    <insert id="insertLocationMoveGoods">
        INSERT IGNORE INTO LOCATION_MOVE_GOODS
        (LMG_LM_IDX, LMG_G_IDX)
        VALUES
        <foreach collection="g_idxs" separator="," item="g_idx">
            (#{lm_idx}, #{g_idx})
        </foreach>
    </insert>

    <select id="countLocationDatatable" resultType="long">
        SELECT
            COUNT(DISTINCT(LOC_IDX))
        FROM
            LOCATION
                LEFT JOIN WAREHOUSE ON LOC_WH_IDX = WH_IDX
                LEFT JOIN USER ON LOC_U_IDX = U_IDX
        <where>
            <include refid="includeLocationDatatable"></include>
        </where>
    </select>

    <update id="changeAllLocType">
        UPDATE
            LOCATION
        SET
            LOC_TYPE = #{locType}
        WHERE
            <foreach collection="locIdxs" open="LOC_IDX IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
    </update>

    <insert id="insertLocationByExcel" parameterType="List">
        INSERT INTO
            LOCATION (LOC_WH_IDX, LOC_CODE, LOC_TYPE, LOC_FORM, LOC_ZONE, LOC_ROW, LOC_COLUMN)
        VALUES
            <foreach collection="list" separator="," item="item">
                (#{item.warehouse.whIdx},
                #{item.locCode},
                #{item.locType},
                #{item.locForm},
                #{item.locZone},
                #{item.locRow},
                #{item.locColumn})
            </foreach>
    </insert>

<!--
    <select id="selectStockInLocationDatatable" resultType="map">
        SELECT
            P_TYPE1,
            P_TYPE2,
            P_TYPE3,
            P_IDX,
            P_NAME,
            G_GS_IDX,
            WH_NAME,
            LOC_ZONE,
            LOC_COLUMN,
            LOC_ROW,
            LOC_CODE,
            COUNT(DISTINCT(G_IDX)) AS G_CNT,
            P_COST
        FROM
            PRODUCT,
            GOODS,
            LOCATION
                LEFT JOIN WAREHOUSE ON LOC_WH_IDX = WH_IDX
        WHERE
            G_LOC_IDX = LOC_IDX
            AND G_P_IDX = P_IDX
        GROUP BY
            LOC_IDX,
            P_IDX
        <if test="length != -1">
            LIMIT #{start}, #{length}
        </if>
    </select>
-->

    <select id="countStockInLocationDatatable" resultType="Long">
        SELECT
            COUNT(*)
        FROM (
             SELECT
                 P_IDX
             FROM
                 product,
                 goods,
                 LOCATION
             WHERE
                 G_LOC_IDX = LOC_IDX
               AND G_P_IDX = P_IDX
             GROUP BY LOC_IDX, P_IDX
             ) AS DT
    </select>

    <select id="selectGoodsByLocation" resultType="Map">
        SELECT
            G_IDX,
            G_STATE,
            G_BARCODE,
            P_NAME,
            P_IDX,
            LOC_WH_IDX,
            LOC_FORM,
            LOC_ZONE,
            LOC_COLUMN,
            LOC_ROW,
            LOC_CODE,
            G_PO_IDX,
            IFNULL(G_IMEI, '') AS G_IMEI
        FROM
            LOCATION
                LEFT JOIN GOODS ON LOC_IDX = G_LOC_IDX
                LEFT JOIN PRODUCT ON G_P_IDX = P_IDX
        WHERE
            LOC_IDX = #{locIdx}
    </select>

    <select id="selectListGoodsByLocation" resultType="Map">
        SELECT
            G_IDX,
            G_STATE,
            G_BARCODE,
            P_NAME,
            P_IDX,
            LOC_IDX,
            LOC_WH_IDX,
            LOC_FORM,
            LOC_ZONE,
            LOC_COLUMN,
            LOC_ROW,
            LOC_CODE,
            G_PO_IDX,
            IFNULL(G_IMEI, '') AS G_IMEI
        FROM
            LOCATION
                LEFT JOIN GOODS ON LOC_IDX = G_LOC_IDX
                LEFT JOIN PRODUCT ON G_P_IDX = P_IDX
        WHERE
        <foreach collection="gIdxs" open="G_BARCODE IN (" separator="," close=")" item="item">
            #{item}
        </foreach>
    </select>


    <select id="selectStockInLocationDatatable" resultType="map">
        SELECT
        P_TYPE1,
        P_TYPE2,
        P_TYPE3,
        P_IDX,
        P_NAME,
        G_GS_IDX,
        WH_NAME,
        LOC_ZONE,
        LOC_COLUMN,
        LOC_ROW,
        LOC_CODE,
        GS_CODE,
        LOC_IDX,
        G_IDX,
        GS_IDX,
        COUNT(DISTINCT(G_IDX)) AS CNT,
        P_COST
        FROM
        PRODUCT,
        GOODS_STOCK
        LEFT JOIN GOODS
        ON G_GS_IDX=GS_IDX
        LEFT JOIN LOCATION
        ON G_LOC_IDX = LOC_IDX
        LEFT JOIN WAREHOUSE ON LOC_WH_IDX = WH_IDX
        WHERE
        G_IDX IS NOT NULL
        GROUP BY GS_CODE,LOC_IDX

        <if test="length != -1">
            LIMIT #{start}, #{length}
        </if>
    </select>

    <select id="selectStockInLocationDatatable2" resultType="map">
        SELECT
        P_TYPE1,
        P_TYPE2,
        P_TYPE3,
        P_IDX,
        P_NAME,
        GS_IDX,
        G_IDX,
        G_BARCODE,
        replace(JSON_EXTRACT(GS_OPTION,'$.OPTION1'),'"','') OPTION1,
        replace(JSON_EXTRACT(GS_OPTION,'$.OPTION2'),'"','') OPTION2,
        replace(JSON_EXTRACT(GS_OPTION,'$.OPTION3'),'"','') OPTION3
        FROM
        goods_stock
        LEFT JOIN goods
        ON G_GS_IDX=GS_IDX
        LEFT JOIN location
        ON G_LOC_IDX=LOC_IDX
        LEFT JOIN PRODUCT
        ON G_P_IDX=P_IDX
        WHERE
        G_IDX IS NOT NULL
        AND GS_IDX=#{gsIdx}
        AND LOC_IDX=#{locIdx}
        <if test="length != -1">
            LIMIT #{start}, #{length}
        </if>
    </select>

    <select id="selectStockMoveDatatable" resultType="map" parameterType="map">
        SELECT
        LM_STATE,
        LM_IDX,
--         CREATED_BY,
        LM_U_IDX,
        LM_OUT_DATE,
        LM_IN_DATE,
        LOC_IDX,
        LOC_WH_IDX,
        LOC_FORM,
        LOC_CODE,
        LM_COUNT
        FROM
        LOCATION
        LEFT JOIN LOCATION_MOVE ON LOC_IDX = LM_LOC_IDX
        LEFT JOIN WAREHOUSE ON WH_IDX=LOC_WH_IDX
        ORDER BY
        LM_IDX DESC
        <if test="length != -1">
            LIMIT #{start}, #{length}
        </if>
    </select>
    <select id="countStockMoveDatatable" resultType="Integer">
        SELECT
        COUNT(*)
        FROM
        LOCATION
        LEFT JOIN LOCATION_MOVE ON LOC_IDX=LM_LOC_IDX
        LEFT JOIN WAREHOUSE ON WH_IDX=LOC_WH_IDX
    </select>

    <select id="selectLocationMoveGoodsList" resultType="map" parameterType="Long">
SELECT
         *
         FROM
             location_move
             LEFT JOIN location_move_goods
             ON LMG_LM_IDX = LM_IDX
             LEFT JOIN goods
             ON LMG_G_IDX=G_IDX
             left join product
             on P_IDX = G_P_IDX
             LEFT JOIN LOCATION ON
             LOC_IDX=LM_LOC_IDX
             LEFT JOIN PO ON PO_IDX = G_PO_IDX

        WHERE
           LM_IDX = #{lmIdx}
    </select>




</mapper>