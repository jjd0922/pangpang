<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.OrderMapper">

    <select id="selectOrderDatatable" resultType="map">
        SELECT
            O_IDX, O_CODE, SHOP_NAME, CU_ID, CU_NAME,
            CU_PHONE, O_LOCATION, PAY_STATE, PAY_METHOD, PAY_PRODUCT_PRICE,
            PAY_DELIVERY, PAY_PRICE,
            if(PAY_STATE='결제취소',PAY_PRICE,0) AS PAY_CANCEL_PRICE,
            PAY_MILEAGE, AD_NAME, AD_PHONE, POST, CONCAT(ADDR1,' ',ADDR2,' ',ADDR3) AS ADDRS,
            ADDR4, AD_ENTRANCE, O_DATE, O_TIME,
            O_POINT, O_COUPON, O_MILEAGE, O_PRICE, O_GS_PRICE,
            (O_GS_PRICE - O_PRICE) O_EVENT,
            if(PAY_JSON!='',replace(JSON_EXTRACT(PAY_JSON,'$.PAY_DATE'),'"',''),'') PAY_DATE,
            if(PAY_JSON!='',replace(JSON_EXTRACT(PAY_JSON,'$.PAY_CODE'),'"',''),'') PAY_CODE,
            if(PAY_JSON!='',replace(JSON_EXTRACT(PAY_JSON,'$.PAY_CANCEL_DATE'),'"',''),'') PAY_CANCEL_DATE,
            if(PAY_JSON!='',replace(JSON_EXTRACT(PAY_JSON,'$.PAY_CANCEL_CODE'),'"',''),'') PAY_CANCEL_CODE

        FROM
            `order`
                LEFT JOIN customer
                    ON CU_IDX=O_CU_IDX
                LEFT JOIN shop
                    ON O_SHOP_IDX=SHOP_IDX
                LEFT JOIN order_address
                    ON O_AD_IDX=AD_IDX
                LEFT JOIN payment
                    ON O_PAY_IDX=PAY_IDX
                LEFT JOIN (SELECT
                                OG_IDX, OG_O_IDX, SUM(OG_POINT) O_POINT, SUM(OG_MILEAGE) O_MILEAGE,
                                SUM(OG_COUPON) O_COUPON, SUM(SPO_PRICE) O_PRICE, SUM(GS_PRICE) O_GS_PRICE
                            FROM
                                order_gs
                                LEFT JOIN shop_product_option
                                ON OG_SPO_IDX=SPO_IDX
                                LEFT JOIN goods_stock
                                ON SPO_GS_IDX=GS_IDX
                                GROUP BY OG_O_IDX)dt
                    ON O_IDX=dt.OG_O_IDX

        order by O_IDX desc
        <if test="length!=-1">
            LIMIT #{start},#{length}
        </if>
    </select>
    <select id="countOrderDatatable" resultType="Integer">
        SELECT
            count(*)
        FROM
            `order`
                LEFT JOIN customer
                          ON CU_IDX=O_CU_IDX
                LEFT JOIN shop
                          ON O_SHOP_IDX=SHOP_IDX
                LEFT JOIN order_address
                          ON O_AD_IDX=AD_IDX
                LEFT JOIN payment
                          ON O_PAY_IDX=PAY_IDX
                LEFT JOIN (SELECT
                               OG_IDX, OG_O_IDX, SUM(OG_POINT) O_POINT, SUM(OG_MILEAGE) O_MILEAGE,
                               SUM(OG_COUPON) O_COUPON, SUM(SPO_PRICE) O_PRICE, SUM(GS_PRICE) O_GS_PRICE
                           FROM
                               order_gs
                                   LEFT JOIN shop_product_option
                                             ON OG_SPO_IDX=SPO_IDX
                                   LEFT JOIN goods_stock
                                             ON SPO_GS_IDX=GS_IDX
                           GROUP BY OG_O_IDX)dt
                            ON O_IDX=dt.OG_O_IDX
    </select>

    <select id="selectOrderDetail" resultType="map">
        SELECT
            O_IDX, O_CODE, SHOP_NAME, CU_ID, CU_NAME, CU_IDX,
            CU_PHONE, O_LOCATION, PAY_STATE, PAY_METHOD, PAY_PRODUCT_PRICE,
            PAY_DELIVERY, PAY_PRICE,
            if(PAY_STATE='결제취소',PAY_PRICE,0) AS PAY_CANCEL_PRICE,
            PAY_MILEAGE, AD_NAME, AD_PHONE, POST, CONCAT(ADDR1,' ',ADDR2,' ',ADDR3) AS ADDRS,
            ADDR1, ADDR2, ADDR3,
            ADDR4, AD_ENTRANCE, O_DATE, O_TIME, AD_MEMO,
            O_POINT, O_COUPON, O_MILEAGE, O_PRICE, O_GS_PRICE,
            (O_GS_PRICE - O_PRICE) O_EVENT,
            if(PAY_JSON!='',replace(JSON_EXTRACT(PAY_JSON,'$.PAY_DATE'),'"',''),'') PAY_DATE,
            if(PAY_JSON!='',replace(JSON_EXTRACT(PAY_JSON,'$.PAY_CODE'),'"',''),'') PAY_CODE,
            if(PAY_JSON!='',replace(JSON_EXTRACT(PAY_JSON,'$.PAY_CANCEL_DATE'),'"',''),'') PAY_CANCEL_DATE,
            if(PAY_JSON!='',replace(JSON_EXTRACT(PAY_JSON,'$.PAY_CANCEL_CODE'),'"',''),'') PAY_CANCEL_CODE

        FROM
            `order`
                LEFT JOIN customer
                          ON CU_IDX=O_CU_IDX
                LEFT JOIN shop
                          ON O_SHOP_IDX=SHOP_IDX
                LEFT JOIN order_address
                          ON O_AD_IDX=AD_IDX
                LEFT JOIN payment
                          ON O_PAY_IDX=PAY_IDX
                LEFT JOIN (SELECT
                               OG_IDX, OG_O_IDX, SUM(OG_POINT) O_POINT, SUM(OG_MILEAGE) O_MILEAGE,
                               SUM(OG_COUPON) O_COUPON, SUM(SPO_PRICE) O_PRICE, SUM(GS_PRICE) O_GS_PRICE
                           FROM
                               order_gs
                                   LEFT JOIN shop_product_option
                                             ON OG_SPO_IDX=SPO_IDX
                                   LEFT JOIN goods_stock
                                             ON SPO_GS_IDX=GS_IDX
                           GROUP BY OG_O_IDX)dt
                          ON O_IDX=dt.OG_O_IDX
        where
            O_IDX=#{O_IDX}
    </select>

</mapper>