<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.PoMapper">
    <sql id="includeEstimateDataTable">
        <if test='peName != null and peName != ""'>AND PE_NAME LIKE CONCAT('%',#{peName},'%')</if>
        <if test='comName != null and comName != ""'>AND COM_NAME LIKE CONCAT('%',#{comName},'%')</if>
        <if test='peCode != null and peCode != ""'>AND PE_CODE LIKE CONCAT('%',#{peCode},'%')</if>
        <if test='createdBy != null and createdBy != ""'>AND PO_ESTIMATE.CREATED_BY LIKE CONCAT('%',#{createdBy},'%')</if>
        <if test='createdDate != null and createdDate != ""'>AND PO_ESTIMATE.CREATED_DATE BETWEEN SUBSTR(#{createdDate}, 1, 10) AND SUBSTR(#{createdDate}, 13)</if>
        <if test='modifiedBy != null and modifiedBy != ""'>AND PO_ESTIMATE.MODIFIED_BY LIKE CONCAT('%',#{modifiedBy},'%')</if>
        <if test='modifiedDate != null and modifiedDate != ""'>AND PO_ESTIMATE.MODIFIED_DATE BETWEEN SUBSTR(#{modifiedDate}, 1, 10) AND SUBSTR(#{modifiedDate}, 13)</if>
        <if test="pePeriod != null and pePeriod != ''">
            AND (PE_START BETWEEN SUBSTR(#{pePeriod}, 1, 10) AND SUBSTR(#{pePeriod}, 13) OR
                PE_END BETWEEN SUBSTR(#{pePeriod}, 1, 10) AND SUBSTR(#{pePeriod}, 13))
        </if>
        <if test='peState != null'>
            <foreach collection="peState" open="AND PE_STATE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
    </sql>
    <select id="selectEstimateDataTable" resultType="Map">
        SELECT
            PE_IDX,
            PE_CODE,
            PE_STATE,
            COM_NAME,
            PE_NAME,
            FORMAT(PE_COUNT , 0) AS 'PE_COUNT',
            FORMAT(PE_COST , 0) AS 'PE_COST',
            PE_FILE,
            PE_FILE_NAME,
            CONCAT(PE_START, ' ~ ', PE_END) AS 'PE_PERIOD',
            PO_ESTIMATE.CREATED_BY AS 'CREATED_BY',
            PO_ESTIMATE.CREATED_DATE AS 'CREATED_DATE',
            PO_ESTIMATE.MODIFIED_BY AS 'MODIFIED_BY',
            PO_ESTIMATE.MODIFIED_DATE AS 'MODIFIED_DATE'
        FROM
            po_estimate
                LEFT JOIN company ON PE_COM_IDX = COM_IDX
        WHERE
            PE_IDX IS NOT NULL
            <include refid="includeEstimateDataTable"></include>
        <if test="length!=-1">
            LIMIT #{start},#{length}
        </if>
    </select>

    <select id="countEstimateDataTable" resultType="Long">
        SELECT
            COUNT(*)
        FROM
            po_estimate
                LEFT JOIN company ON PE_COM_IDX = COM_IDX
        WHERE
            PE_IDX IS NOT NULL
            <include refid="includeEstimateDataTable"></include>
    </select>

    <select id="selectEstimateProduct" resultType="Map">
        SELECT
            P_IDX,
            P_CODE,
            P_NAME,
            brand.CATE_NAME AS 'BRAND',
            category.CATE_NAME AS 'CATEGORY',
            P_SELL_PRICE,
            FORMAT(P_SELL_PRICE , 0) AS 'P_SELL_PRICE_COMMA',
            PEP_COUNT,
            PEP_COST,
            FORMAT(PEP_COUNT * PEP_COST , 0) AS 'SUM'
        FROM
            po_estimate
                LEFT JOIN po_estimate_product ON PE_IDX = PEP_PE_IDX
                LEFT JOIN product ON PEP_P_IDX = P_IDX
                LEFT JOIN category AS category ON P_CATE_IDX = category.CATE_IDX
                LEFT JOIN category AS brand ON P_CATE_IDX2 = brand.CATE_IDX
        WHERE
            PE_IDX = #{peIdx}
        AND
            PEP_IDX IS NOT NULL
    </select>

    <sql id="includePoDataTable">

    </sql>
    <select id="selectPoDataTable" resultType="Map">
        SELECT
            *
        FROM
            PO
        <where>
            <include refid="includePoDataTable"></include>
        </where>
        <if test="length!=-1">
        LIMIT #{start},#{length}
        </if>
    </select>
    <select id="countPoDataTable" parameterType="map" resultType="Integer">
        SELECT
            COUNT(*)
        FROM
            PO
        <where>
            <include refid="includePoDataTable"></include>
        </where>
    </select>

    <sql id="includeInDatatable">
        AND (PO_TYPE = 'EMERGENCY' OR PO_STATE = 'APPROVAL')
    </sql>
    <select id="selectInDatatable" parameterType="map" resultType="map">
        SELECT
            *
        FROM
            PO
        <where>
            <include refid="includeInDatatable"></include>
        </where>
    </select>
    <select id="countInDatatable" parameterType="map" resultType="Integer">
        SELECT
            COUNT(*)
        FROM
            PO
        <where>
            <include refid="includeInDatatable"></include>
        </where>
    </select>
    <sql id="includePoApprovedDatatable">
        (PO_TYPE = 'EMERGENCY' OR PO_STATE = 'APPROVAL')

    </sql>
    <select id="selectPoApprovedDatatable" resultType="map" parameterType="map">
        SELECT
            *
        FROM
            PO
        <where>
            <include refid="includePoApprovedDatatable"></include>
        </where>

        <if test="length!=-1">
            LIMIT #{start},#{length}
        </if>
    </select>
    <select id="countPoApprovedDatatable" resultType="Integer" parameterType="map">
        SELECT
            COUNT(*)
        FROM
            PO
        <where>
            <include refid="includePoApprovedDatatable"></include>
        </where>
    </select>


</mapper>