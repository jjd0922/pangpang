<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.ProcessMapper">
    <sql id="includeProcessNeedDataTable">
        <if test="gIdx != null and gIdx != ''">AND PN_G_IDX = #{gIdx}</if>
        <if test="pgIdx != null and pgIdx != ''">AND PN_PG_IDX = #{pgIdx}</if>
        <if test="pnIdx != null and pnIdx != ''">AND PN_IDX = #{pnIdx}</if>
        <if test="pnType != null and pnType != ''">AND PN_TYPE = #{pnType}</if>
        <if test="pnState != null and pnState != ''">AND PN_STATE = #{pnState}</if>
        <if test="pnProcess != null and pnProcess != ''">AND PN_PROCESS = #{pnProcess}</if>
        <if test="cgIdx != null and cgIdx != ''">AND PN_CG_IDX = #{cgIdx}</if>
    </sql>
    <select id="selectProcessNeed" resultType="Map">
        SELECT
            *
        FROM
            PROCESS_NEED
                LEFT JOIN GOODS ON PN_G_IDX = G_IDX
                LEFT JOIN PRODUCT ON G_P_IDX = P_IDX
                LEFT JOIN CATEGORY ON P_CATE_IDX = CATE_IDX
        <where>
            <include refid="includeProcessNeedDataTable"></include>
        </where>
    </select>

    <select id="selectProcessNeedEntity" resultType="com.newper.entity.ProcessNeed">
        SELECT
            *
        FROM
            PROCESS_NEED
                LEFT JOIN GOODS ON PN_G_IDX = G_IDX
        <where>
            <include refid="includeProcessNeedDataTable"></include>
        </where>
    </select>

    <sql id="includeProcessGroupDataTable">
        <if test="pgType != null and pgType != ''">AND PG_TYPE = #{pgType}</if>
    </sql>
    <select id="selectProcessGroupDatatable" resultType="Map">
        SELECT
            *
        FROM
            PROCESS_GROUP
        <where>
            <include refid="includeProcessGroupDataTable"></include>
        </where>
    </select>

    <select id="countProcessGroupDatatable" resultType="long">
        SELECT
            COUNT(*)
        FROM
            PROCESS_GROUP
        <where>
            <include refid="includeProcessGroupDataTable"></include>
        </where>
    </select>


    <sql id="includeProcessSpec">
        <if test="gIdx != null and gIdx != ''">AND G_IDX = #{gIdx}</if>
        <if test="pnCount != null and pnCount != ''">AND PN_COUNT = #{pnCount}</if>
        <if test="pnIdx != null and pnIdx != ''">AND PS_PN_IDX = #{pnIdx}</if>
        <if test='psType != null'>
            <foreach collection="psType" open="AND PS_TYPE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        AND GS_IDX IS NOT NULL
    </sql>

    <select id="selectProcessSpec" resultType="Map">
        SELECT
            *
        FROM
            PROCESS_NEED
                LEFT JOIN PROCESS_SPEC ON PN_IDX = PS_PN_IDX
                LEFT JOIN GOODS_STOCK ON PS_GS_IDX1 = GS_IDX
                LEFT JOIN PRODUCT ON GS_P_IDX = P_IDX
        <where>
            <include refid="includeProcessSpec"></include>
        </where>
    </select>

    <insert id="insertResellGoods">
        INSERT INTO RESELL_GOODS (
            RG_RS_IDX,
            RG_G_IDX
        ) VALUES
        <foreach collection="gIdxs" item="gIdx" separator=",">
        (
            #{rsIdx},
            #{gIdx}
        )
        </foreach>
    </insert>

    <select id="selectResellComIdx" resultType="Map">
        SELECT
            *
        FROM
            GOODS_TEMP
                LEFT JOIN GOODS ON GT_G_IDX = G_IDX
                LEFT JOIN PO ON G_PO_IDX = PO_IDX
                LEFT JOIN COMPANY ON PO_COM_IDX = COM_IDX
        WHERE
            GT_GGT_IDX = #{ggt_idx}
        LIMIT
	        0, 1
    </select>

    <sql id="includeResellDatatable">
        <if test="rsIdx != null and rdIdx != ''">RS_IDX LIKE CONCAT ('%', #{rsIdx}, '%')</if>
        <if test="rsState != null and rsState != ''">RS_STATE = #{rsState}</if>
        <if test="comName != null and comName != ''">RS_IDX LIKE CONCAT ('%', #{comName}, '%')</if>
        <if test="buy_uName != null and buy_uName != ''">RS_IDX LIKE CONCAT ('%', #{buy_uName}, '%')</if>
        <if test="start_uName != null and start_uName != ''">RS_IDX LIKE CONCAT ('%', #{start_uName}, '%')</if>
        <if test="rgStartDate != null and rgStartDate != ''">RS_IDX LIKE CONCAT ('%', #{rgStartDate}, '%')</if>
        <if test="end_uName != null and end_uName != ''">RS_IDX LIKE CONCAT ('%', #{end_uName}, '%')</if>
        <if test="rgEndDate != null and rgEndDate != ''">RS_IDX LIKE CONCAT ('%', #{rgEndDate}, '%')</if>
        <if test="createdBy != null and createdBy != ''">RS_IDX LIKE CONCAT ('%', #{createdBy}, '%')</if>
        <if test="createdDate != null and createdDate != ''">RS_IDX LIKE CONCAT ('%', #{createdDate}, '%')</if>
    </sql>

    <select id="selectResellDatatable" resultType="Map">
        SELECT
            *
        FROM
            RESELL
                LEFT JOIN COMPANY ON RS_COM_IDX = COM_IDX
        <where>
            <include refid="includeResellDatatable"></include>
        </where>
        <if test="length != -1">
            LIMIT
                #{start}, #{length}
        </if>
    </select>

    <select id="countResellDatatable" resultType="long">
        SELECT
            COUNT(*)
        FROM
            RESELL
                LEFT JOIN COMPANY ON RS_COM_IDX = COM_IDX
        <where>
            <include refid="includeResellDatatable"></include>
        </where>
    </select>

    <select id="selectGoodsResell" resultType="Map">
        SELECT
            *
        FROM
            RESELL
                LEFT JOIN RESELL_GOODS ON RS_IDX = RG_RS_IDX
                LEFT JOIN GOODS ON RG_G_IDX = G_IDX
        <if test="length != -1">
        LIMIT
            #{start}, #{length}
        </if>
    </select>

    <select id="countGoodsResell" resultType="long">
        SELECT
            COUNT(*)
        FROM
            RESELL
                LEFT JOIN RESELL_GOODS ON RS_IDX = RG_RS_IDX
                LEFT JOIN GOODS ON RG_G_IDX = G_IDX
    </select>

    <sql id="includeCheckDatatable">
        <if test="cgType != null and cgType != ''">AND CG_TYPE = #{cgType}</if>
    </sql>
    
    <select id="selectCheckDatatable" resultType="Map">
        SELECT
            *
        FROM
            CHECK_GROUP
        <where>
            <include refid="includeCheckDatatable"></include>
        </where>
        <if test="length != -1">
        LIMIT
            #{start}, #{length}
        </if>
    </select>

    <select id="countCheckDatatable" resultType="Long">
        SELECT
            COUNT(*)
        FROM
            CHECK_GROUP
        <where>
            <include refid="includeCheckDatatable"></include>
        </where>
    </select>

    
    <sql id="includeProcessNeedDatatable">
        <if test="gIdx != null and gIdx != ''">AND G_IDX = #{gIdx}</if>
        <if test="pnCount != null and pnCount != ''">AND PN_COUNT = #{pnCount}</if>
    </sql>
    <select id="selectProcessNeedDatatable" resultType="Map">
        SELECT
            PN_IDX,
            PN_TYPE,
            PN_CONTENT,
            PN_EXPECTED_COST,
            PN_PROCESS
        FROM
            GOODS
                LEFT JOIN PROCESS_NEED ON G_IDX = PN_G_IDX
        <where>
            <include refid="includeProcessNeedDatatable"></include>
        </where>
    </select>

    <select id="goodsProcessCheck" resultType="Map">
        SELECT
            *
        FROM
            PROCESS_NEED
        WHERE
            PN_TYPE = #{type}
        AND
            PN_STATE = 'NEED'
        AND
            PN_PROCESS = 'YES'
        AND
            PN_G_IDX = #{gIdx}
    </select>

    <update id="updateProcessNeed">
        UPDATE
            PROCESS_NEED
        SET
            PN_PROCESS = #{pnProcess},
            PN_STATE = #{pnState},
            PN_PG_IDX = #{processGroup.pgIdx}
        WHERE
            PN_IDX = #{pnIdx}
    </update>

    <select id="selectProcessNeedByGoods" resultType="Integer">
        SELECT
            COUNT(*)
        FROM
            PROCESS_NEED
        WHERE
            PN_G_IDX = #{gIdx}
        AND
            PN_PROCESS = 'YES'
        AND
            PN_STATE = 'REQUEST'
    </select>

    <select id="selectProcessNeedCount" resultType="Integer">
        SELECT
            COUNT(*)
        FROM
            PROCESS_NEED
        WHERE
            PN_G_IDX = #{gIdx}
        AND
            PN_TYPE = #{pnType}
        ORDER BY
            PN_COUNT DESC
        LIMIT
            0, 1
    </select>

    <insert id="insertGoodsTemp">
        INSERT INTO GOODS_TEMP (
            GT_GGT_IDX,
            GT_G_IDX,
            GT_CREATED_DATETIME
        ) VALUES (
            #{ggtIdx},
            #{gIdx},
            NOW()
        )
    </insert>

    <select id="selectGoodsTemp" resultType="Long">
        SELECT
            GT_G_IDX
        FROM
            GOODS_TEMP
        WHERE
            GT_GGT_IDX = #{ggtIdx}
    </select>

    <select id="checkProcessNeed" resultType="Integer">
        SELECT
            COUNT(*)
        FROM
            PROCESS_NEED
                LEFT JOIN GOODS ON PN_G_IDX = G_IDX
        WHERE
            PN_TYPE = #{pnType}
        AND
            G_IDX = #{gIdx}
        AND
            PN_STATE = 'NEED'
        AND
            PN_PROCESS = 'Y'
    </select>

    <select id="selectProcessNeedByGroup" resultType="Map">
        SELECT
            *
        FROM
            PROCESS_GROUP
                LEFT JOIN PROCESS_NEED ON PG_IDX = PN_PG_IDX
                LEFT JOIN GOODS ON PN_G_IDX = G_IDX
        <where>
            <include refid="includeProcessNeedDataTable"></include>
        </where>
    </select>

    <select id="countProcessNeedByGroup" resultType="Long">
        SELECT
            COUNT(*)
        FROM
            PROCESS_GROUP
                LEFT JOIN PROCESS_NEED ON PG_IDX = PN_PG_IDX
                LEFT JOIN GOODS ON PN_G_IDX = G_IDX
        <where>
            <include refid="includeProcessNeedDataTable"></include>
        </where>
    </select>

    <select id="checkProcessNeedOther" resultType="Integer">
        SELECT
            COUNT(*)
        FROM
            PROCESS_NEED
        WHERE
            PN_G_IDX = #{gIdx}
        AND
            PN_STATE = 'NEED'
          AND
            PN_PROCESS = 'Y'
    </select>

    <select id="checkProcessSpec" resultType="Integer">
        SELECT
            COUNT(*)
        FROM
            PROCESS_SPEC
                LEFT JOIN PROCESS_NEED ON PS_PN_IDX = PN_IDX
        WHERE
            PS_PN_IDX = #{pnIdx}
    </select>

    <select id="selectCheckGoods" resultType="Map">
        SELECT
            *
        FROM
            CHECK_GROUP
                LEFT JOIN CHECK_GOODS ON CG_IDX = CGS_CG_IDX
                LEFT JOIN GOODS ON CGS_G_IDX = G_IDX
                LEFT JOIN PO ON G_PO_IDX = PO_IDX
                LEFT JOIN PRODUCT ON G_P_IDX = P_IDX
                LEFT JOIN CATEGORY ON P_CATE_IDX = CATE_IDX
        WHERE
            CG_IDX = #{cgIdx}
        <if test="length != -1">
        LIMIT
            #{start}, #{length}
        </if>
    </select>

    <select id="countCheckGoods" resultType="Long">
        SELECT
            COUNT(*)
        FROM
            CHECK_GROUP
                LEFT JOIN CHECK_GOODS ON CG_IDX = CGS_CG_IDX
                LEFT JOIN GOODS ON CGS_G_IDX = G_IDX
                LEFT JOIN PO ON G_PO_IDX = PO_IDX
                LEFT JOIN PROCESS_NEED ON PN_CG_IDX = CG_IDX AND G_IDX = PN_G_IDX
                LEFT JOIN PRODUCT ON G_P_IDX = P_IDX
                LEFT JOIN CATEGORY ON P_CATE_IDX = CATE_IDX
        WHERE
            CG_IDX = #{cgIdx}
    </select>
</mapper>