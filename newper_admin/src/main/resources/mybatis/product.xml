<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.ProductMapper">
    <select id="selectProductDataTable" resultType="Map">
        SELECT
            dt.CATE_SPEC_LIST AS 'CATE_SPEC_LIST',
            product.*,
            FORMAT(P_SELL_PRICE , 0) AS 'P_SELL_PRICE',
            (case
                 when dt.CATE_DEPTH = 1 then dt.CATE_NAME1
                 when dt.CATE_DEPTH = 2 then dt.CATE_NAME2
                 when dt.CATE_DEPTH = 3 then dt.CATE_NAME3
                end
                ) CATE_NAME1,
            (case
             when dt.CATE_DEPTH = 3 then dt.CATE_NAME2
             when dt.CATE_DEPTH = 2 then dt.CATE_NAME1
            end
            ) CATE_NAME2,
            if(dt.CATE_DEPTH=3,dt.CATE_NAME1,NULL) CATE_NAME3,
            brand.CATE_NAME as 'BRAND_NAME',
                store.COM_NAME AS 'STORE_NAME',
                manufacture.COM_NAME AS 'MANUFACTURE_NAME',
                afterservice.COM_NAME AS 'AFTERSERVICE_NAME',
            replace(JSON_EXTRACT(P_OPTION,'$.p_option_value1'),'"','') OPTION1,
            replace(JSON_EXTRACT(P_OPTION,'$.p_option_value2'),'"','') OPTION2,
            replace(JSON_EXTRACT(P_OPTION,'$.p_option_value3'),'"','') OPTION3
        FROM
            product
                LEFT JOIN (SELECT
                               category1.CATE_NAME AS CATE_NAME1,
                               category1.CATE_IDX AS CATE_IDX1,
                               category1.CATE_DEPTH,
                               category1.CATE_SPEC_LIST AS CATE_SPEC_LIST,
                               category2.CATE_NAME AS CATE_NAME2,
                               category2.CATE_IDX AS CATE_IDX2,
                               category3.CATE_NAME AS CATE_NAME3,
                               category3.CATE_IDX AS CATE_IDX3

                           FROM
                               category AS category1
                                   LEFT JOIN category AS category2
                                             ON category1.CATE_PARENT_IDX = category2.CATE_IDX
                                   LEFT JOIN category AS category3
                                             ON category2.CATE_PARENT_IDX = category3.CATE_IDX)dt
                          ON dt.CATE_IDX1=P_CATE_IDX

                LEFT JOIN category AS brand
                    ON P_CATE_IDX2 = brand.CATE_IDX
                LEFT JOIN company AS store
                    ON P_COM_IDX = store.COM_IDX
                LEFT JOIN company AS manufacture
                    ON P_COM_IDX2 = manufacture.COM_IDX
                LEFT JOIN company AS afterservice
                    ON P_COM_IDX3 = afterservice.COM_IDX
        WHERE
            P_IDX is not null
            order by P_IDX desc
        <if test="length!=-1">
            limit #{start},#{length}
        </if>
    </select>

    <select id="countProductDataTable" resultType="long">
        SELECT
            COUNT(*)
        FROM
            product
                LEFT JOIN (SELECT
                               category1.CATE_NAME AS CATE_NAME1,
                               category1.CATE_IDX AS CATE_IDX1,
                               category1.CATE_DEPTH,
                               category2.CATE_NAME AS CATE_NAME2,
                               category2.CATE_IDX AS CATE_IDX2,
                               category3.CATE_NAME AS CATE_NAME3,
                               category3.CATE_IDX AS CATE_IDX3
                           FROM
                               category AS category1
                                   LEFT JOIN category AS category2
                                             ON category1.CATE_PARENT_IDX = category2.CATE_IDX
                                   LEFT JOIN category AS category3
                                             ON category2.CATE_PARENT_IDX = category3.CATE_IDX)dt
                          ON dt.CATE_IDX1=P_CATE_IDX

                LEFT JOIN category AS brand
                          ON P_CATE_IDX2 = brand.CATE_IDX
                LEFT JOIN company AS store
                          ON P_COM_IDX = store.COM_IDX
                LEFT JOIN company AS manufacture
                          ON P_COM_IDX2 = manufacture.COM_IDX
                LEFT JOIN company AS afterservice
                          ON P_COM_IDX3 = afterservice.COM_IDX
    </select>

    <select id="selectProductByListPcode" resultType="String">
        select
            P_CODE
        from
            product
        order by P_IDX desc limit 1
    </select>

    <select id="selectGoodsStockDataTable" resultType="map">
        SELECT
        GS_IDX, GS_THUMB_FILE1, P_CODE, P_STATE, P_NAME, P_IDX,
        P_MODEL, P_COST, P_SELL_PRICE, GS_CODE, GS_NAME,
        GS_PRICE, GS_SALE, GS_RANK, GS_SAFE_STOCK, GS_PROPER_STOCK,
        GS_DAILY, goods_stock.CREATED_BY, goods_stock.CREATED_DATE, goods_stock.MODIFIED_BY, goods_stock.MODIFIED_DATE,
        replace(JSON_EXTRACT(GS_OPTION,'$.OPTION1'),'"','') OPTION1,
        replace(JSON_EXTRACT(GS_OPTION,'$.OPTION2'),'"','') OPTION2,
        replace(JSON_EXTRACT(GS_OPTION,'$.OPTION3'),'"','') OPTION3
        FROM
        goods_stock
        LEFT JOIN product
        ON GS_P_IDX=P_IDX
        WHERE
        GS_IDX IS NOT null
        order by P_IDX desc
        <if test="length!=-1">
            limit #{start},#{length}
        </if>
    </select>
    <select id="countGoodsStockDataTable" resultType="Integer">
        select
            count(*)
        from
            goods_stock
                LEFT JOIN product
                          ON GS_P_IDX=P_IDX
        WHERE
            GS_IDX IS NOT null
    </select>

    <select id="selectGoodsStockByListGsCode" resultType="String">
        select
            GS_CODE
        from
            goods_stock
        order by GS_IDX desc limit 1
    </select>
</mapper>