<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.ScheduleMapper">
    <sql id="includeScheduleDatatable">
        <if test="sIdx != null and sIdx != ''">AND S_IDX LIKE CONCAT('%',#{sIdx},'%')</if>
        <if test="sState != null">
            <foreach collection="sState" open="AND S_STATE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="sRequestDate != null and sRequestDate != ''">AND S_REQUEST_DATE BETWEEN SUBSTR(#{sRequestDate}, 1, 10) AND SUBSTR(#{sRequestDate}, 13)</if>
        <if test="sDate != null and sDate != ''">AND S_DATE BETWEEN SUBSTR(#{sDate}, 1, 10) AND SUBSTR(#{sDate}, 13)</if>
        <if test="sCompletionDate != null and sCompletionDate != ''">AND S_COMPLETION_DATE BETWEEN SUBSTR(#{sCompletionDate}, 1, 10) AND SUBSTR(#{sCompletionDate}, 13)</if>
        <if test="comName != null and comName != ''">AND COM_NAME LIKE CONCAT('%',#{comName},'%')</if>
        <if test="sType != null">
            <foreach collection="sType" open="AND S_TYPE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="sTitle != null and sTitle != ''">AND S_TITLE LIKE CONCAT('%',#{sTitle},'%')</if>
    </sql>

    <select id="selectScheduleDatatable" resultType="map">
        SELECT
            S_IDX,
            S_STATE,
            S_REQUEST_DATE,
            S_DATE,
            DATE_FORMAT(S_TIME,'%H:%i') AS S_TIME,
            S_COMPLETION_DATE,
            S_COM_NAME,
            S_COM_NUM,
            S_TYPE,
            S_COUNT,
            S_TITLE,
            S_ATTENDEES
        FROM
            SCHEDULE
                LEFT JOIN COMPANY ON S_COM_IDX = COM_IDX
        <where>
            <include refid="includeScheduleDatatable"></include>
        </where>
        ORDER BY
            S_DATE DESC,
            FIELD(S_STATE,'COMPLETE','CANCELED','RESCHEDULE'),
            S_TIME DESC,
            S_IDX DESC
        <if test="length != -1">
            LIMIT #{start}, #{length}
        </if>
    </select>

    <select id="countScheduleDatatable" resultType="long">
        SELECT
            COUNT(DISTINCT(S_IDX))
        FROM
            SCHEDULE
                LEFT JOIN COMPANY ON S_COM_IDX = COM_IDX
        <where>
            <include refid="includeScheduleDatatable"></include>
        </where>
    </select>
</mapper>