<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.StockMapper">
    <select id="selectStockDatatableByParent" resultType="map">
        SELECT
            P_NAME, P_IDX, GS_CODE, count(GS_IDX) as cnt, GS_IDX,ifnull(dt.loc_cnt,0) loc_cnt,ifnull(ct.check_cnt,0) check_cnt

        FROM
            ORDERS
                LEFT JOIN ORDER_GS
                          ON OG_O_IDX=O_IDX
                LEFT JOIN delivery_num
                          ON OG_DN_IDX=DN_IDX
                LEFT JOIN shop_product_option
                          ON SPO_IDX=OG_SPO_IDX
                LEFT JOIN GOODS_STOCK
                          ON SPO_GS_IDX=GS_IDX
                LEFT JOIN PRODUCT
                          ON P_IDX=GS_P_IDX
                LEFT JOIN (SELECT
                               G_GS_IDX,COUNT(*) loc_cnt
                           FROM
                               goods
                                   LEFT JOIN location
                                             ON G_LOC_IDX=LOC_IDX
                           WHERE
                               G_LOC_IDX IS NOT NULL
                             and G_STATE='STOCK'
                             AND G_STOCK_STATE='STOCK'
                           GROUP BY G_GS_IDX
                           HAVING G_GS_IDX IS NOT null) dt
                          ON dt.G_GS_IDX=SPO_GS_IDX
                LEFT JOIN (SELECT
                               GS_IDX AS GS_IDX1,COUNT(*) check_cnt
                           FROM
                               goods_stock
                                   LEFT JOIN goods
                                             ON GS_IDX=G_GS_IDX
                           WHERE
                               G_STATE = 'STOCK'
                             AND G_STOCK_STATE='OUT_REQ'
                           GROUP BY GS_IDX
            )ct
                          ON ct.GS_IDX1=SPO_GS_IDX
        WHERE
            DN_IDX IS NOT NULL
        group by GS_IDX
    </select>

    <select id="selectStockDatatableByChildren" resultType="map">
        SELECT
            P_NAME,P_IDX,GS_CODE,G_BARCODE,WH_NAME,
            LOC_TYPE,LOC_CODE,LOC_FORM,LOC_ZONE,location.CREATED_DATE,
            U_NAME, G_IDX
        FROM
            goods
                LEFT JOIN location
                          ON G_LOC_IDX=LOC_IDX
                LEFT JOIN warehouse
                          ON LOC_WH_IDX=WH_IDX
                LEFT JOIN product
                          ON G_P_IDX=P_IDX
                LEFT JOIN goods_stock
                          on G_GS_IDX=GS_IDX
                left join user
                          on LOC_U_IDX=U_IDX
        WHERE
            G_LOC_IDX IS NOT NULL
            and G_STATE='STOCK'
            and G_STOCK_STATE = #{G_STOCK_STATE}
            and G_GS_IDX=#{GS_IDX}
    </select>




    <sql id="includeStockDataTable">
        <if test="pIdx != null and pIdx != ''">AND P_IDX = #{pIdx}</if>
        <if test="pName != null and pName != ''">AND P_IDX LIKE CONCAT('%', #{pName}, '%')</if>
        <if test="pIdx != null and pIdx != ''">AND P_IDX = #{pIdx}</if>
        <if test="onlyParts == 'true'">AND P_TYPE2 = 'PARTS'</if>
        <if test="speclName != null and speclName != ''">AND SPECL_NAME = #{speclName}</if>
        <if test="gsIdx != null and gsIdx != ''">AND GS_IDX = #{gsIdx}</if>
    </sql>

    <select id="selectStockDataTable" resultType="map" parameterType="map">
        SELECT
            *
        FROM
            GOODS_STOCK
                LEFT JOIN PRODUCT ON GS_P_IDX = P_IDX
        <where>
            <include refid="includeStockDataTable"></include>
        </where>
    </select>

    <select id="countStockDataTable" resultType="integer">
        SELECT
            COUNT(*)
        FROM
            GOODS_STOCK
                LEFT JOIN GOODS ON GS_IDX = G_GS_IDX
                LEFT JOIN PRODUCT ON GS_P_IDX = P_IDX
        <where>
            <include refid="includeStockDataTable"></include>
        </where>
    </select>

    <select id="selectStockParts" resultType="map">
        SELECT
            *,
            replace(JSON_EXTRACT(GS_OPTION,'$.OPTION1'),'"','') OPTION1,
            replace(JSON_EXTRACT(GS_OPTION,'$.OPTION2'),'"','') OPTION2,
            replace(JSON_EXTRACT(GS_OPTION,'$.OPTION3'),'"','') OPTION3
        FROM
            GOODS_STOCK
                LEFT JOIN GOODS ON GS_IDX = G_GS_IDX
                LEFT JOIN PRODUCT ON GS_P_IDX = P_IDX
                LEFT JOIN SPEC ON GS_SPEC_IDX = SPEC_IDX
                LEFT JOIN SPEC_ITEM ON SPEC_IDX = SPECI_SPEC_IDX
                LEFT JOIN SPEC_LIST ON SPECI_SPECL_IDX = SPECL_IDX
        <where>
            <include refid="includeStockDataTable"></include>
        </where>
        <if test="length != -1">
        LIMIT
            #{start},#{length}
        </if>
    </select>

    <select id="countStockParts" resultType="long">
        SELECT
            COUNT(*)
        FROM
            GOODS_STOCK
                LEFT JOIN GOODS ON GS_IDX = G_GS_IDX
                LEFT JOIN PRODUCT ON GS_P_IDX = P_IDX
                LEFT JOIN SPEC ON GS_SPEC_IDX = SPEC_IDX
                LEFT JOIN SPEC_ITEM ON SPEC_IDX = SPECI_SPEC_IDX
                LEFT JOIN SPEC_LIST ON SPECI_SPECL_IDX = SPECL_IDX
        <where>
            <include refid="includeStockDataTable"></include>
        </where>
    </select>
</mapper>