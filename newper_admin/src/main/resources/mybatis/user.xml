<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.UserMapper">

    <sql id="includeUserDatatable">
        <if test="U_NAME != null and U_NAME != ''">AND U_NAME LIKE CONCAT('%',#{U_NAME},'%')</if>
        <if test="U_PHONE != null and U_PHONE != ''">AND U_PHONE LIKE CONCAT('%',#{U_PHONE},'%')</if>
        <if test="U_DEPART != null and  U_DEPART!=''">AND U_DEPART LIKE CONCAT('%',#{U_DEPART},'%')</if>
        <if test="U_POSITION != null and U_POSITION !=''">AND U_POSITION LIKE CONCAT('%',#{U_POSITION},'%')</if>
        <if test="COM_NAME != null and COM_NAME !=''">AND COM_NAME like CONCAT('%',#{COM_NAME},'%')</if>
        <if test="U_ID != null and U_ID != ''">AND U_ID LIKE CONCAT('%',#{U_ID},'%')</if>
        <if test="U_PERSON_MAIL != null and U_PERSON_MAIL != ''">AND U_PERSON_MAIL LIKE CONCAT('%',#{U_PERSON_MAIL},'%')</if>
        <if test="createdDate != null and createdDate != ''">AND USER.CREATED_DATE BETWEEN SUBSTR(#{createdDate}, 1, 10) AND SUBSTR(#{createdDate}, 13)</if>
        <if test='U_STATE != null'>
        <foreach collection="U_STATE" open="AND U_STATE IN (" separator="," close=")" item="item">
            #{item}
        </foreach>
        </if>
    </sql>

    <sql id="includeUserForCompany">
        <if test="uName != null and uName !=''">AND U_NAME LIKE CONCAT('%',#{uName},'%')</if>
        <if test="uPhone != null and uPhone !=''">AND U_PHONE LIKE CONCAT('%',#{uPhone},'%')</if>
        <if test="uId != null and uId !=''">AND U_ID LIKE CONCAT('%',#{uId},'%')</if>
        <if test="uDepart != null and uDepart !=''">AND U_DEPART LIKE CONCAT('%',#{uDepart},'%')</if>
        <if test="uPosition != null and uPosition !=''">AND U_POSITION LIKE CONCAT('%',#{uPosition},'%')</if>
        <if test="uState != null and uState !=''">AND U_STATE = #{uState}</if>
        <if test="createdDate != null and createdDate != ''">AND CREATED_DATE BETWEEN SUBSTR(#{createdDate}, 1, 10) AND SUBSTR(#{createdDate}, 13)</if>
    </sql>

    <select id="selectUserDatatable" resultType="Map" parameterType="Map">
        SELECT
        *
        FROM
        user
        LEFT JOIN company

        ON u_com_idx=com_idx
        LEFT JOIN auth
        ON u_auth_idx=auth_idx
        where
            U_IDX!=1
        <include refid="includeUserDatatable"></include>

        <if test="length!=-1">
            limit #{start},#{length}
        </if>
    </select>

    <select id="countUserDatatable" resultType="Integer">
        SELECT
            COUNT(*)
        FROM
            User
                LEFT JOIN COMPANY ON u_com_idx = Com_idx
        where
        U_IDX!=1
             <include refid="includeUserDatatable"></include>
    </select>

    <select id="selectUserForCompany" resultType="Map">
        SELECT
            U_IDX,
            U_NAME,
            U_PHONE,
            U_ID,
            U_DEPART,
            U_POSITION,
            U_PERSON_MAIL,
            U_COMPANY_TEL,
            U_STATE
        FROM
            USER
        WHERE
            U_TYPE = 'INSIDE'
            <include refid="includeUserForCompany"></include>
    </select>

    <select id="countUserForCompany" resultType="Long">
        SELECT
            COUNT(*)
        FROM
            USER
        WHERE
            U_TYPE = 'INSIDE'
            <include refid="includeUserForCompany"></include>
    </select>
    <select id="selectUserLogin" resultType="map">
        SELECT
             U_IDX,U_AUTH_IDX
            ,U_ID, U_PASSWORD, U_TYPE, U_STATE
            ,SHA2(#{pw},512) = U_PASSWORD PW_CHECK
        FROM
            USER
        WHERE
            U_ID=#{id}
    </select>
</mapper>
