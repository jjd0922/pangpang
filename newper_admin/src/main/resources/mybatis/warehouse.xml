<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.WarehouseMapper">
    <sql id="includeWarehouseDatatable">
        <if test="whState != null">
            <foreach collection="whState" open="AND WH_STATE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="whName != null and whName !=''">AND WH_NAME LIKE CONCAT('%',#{whName},'%')</if>
        <if test="comName != null and comName != ''">AND COM_NAME LIKE CONCAT('%',#{comName},'%')</if>
        <if test="ceName != null and ceName != ''">AND CE_NAME LIKE CONCAT('%',#{ceName},'%')</if>
    </sql>
    <select id="selectWarehouseDatatable" resultType="map">
        SELECT
            WH_IDX,
            WH_STATE,
            WH_NAME,
            COM_NAME,
            CE_NAME
        FROM
            WAREHOUSE
                LEFT JOIN COMPANY ON WH_COM_IDX = COM_IDX
                LEFT JOIN COMPANY_EMPLOYEE ON COM_CE_IDX = CE_IDX
        <where>
            <include refid="includeWarehouseDatatable"></include>
        </where>
        ORDER BY
            WH_IDX DESC
        <if test="length != -1">
            LIMIT #{start},#{length}
        </if>
    </select>

    <select id="countWarehouseDatatable" resultType="long">
        SELECT
            COUNT(DISTINCT(WH_IDX))
        FROM
            WAREHOUSE
                LEFT JOIN COMPANY ON WH_COM_IDX = COM_IDX
                LEFT JOIN COMPANY_EMPLOYEE ON COM_CE_IDX = CE_IDX
        <where>
            <include refid="includeWarehouseDatatable"></include>
        </where>
    </select>

    <update id="changeAllWhState">
        UPDATE
            WAREHOUSE
        SET
            WH_STATE = #{whState}
        WHERE
            <foreach collection="whIdxs" open="WH_IDX IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
    </update>

    <sql id="includeLocationDatatable">
        <if test="locType != null">
            <foreach collection="locType" open="AND LOC_TYPE IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="locForm != null">
            <foreach collection="locForm" open="AND LOC_FORM IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
        </if>
        <if test="locCode != null and locCode != ''">AND LOC_CODE LIKE CONCAT('%',#{locCode},'%')</if>
        <if test="locZone != null and locZone != ''">AND LOC_ZONE LIKE CONCAT('%',#{locZone},'%')</if>
        <if test="locRow != null and locRow != ''">AND LOC_ROW LIKE CONCAT('%',#{locRow},'%')</if>
        <if test="locColumn != null and locColumn != ''">AND LOC_COLUMN LIKE CONCAT('%',#{locColumn},'%')</if>
        <if test="location != null and location != ''">AND CONCAT(LOC_ZONE,LOC_COLUMN,LOC_ROW) LIKE CONCAT('%',#{location},'%')</if>
        <if test="uName != null and uName != ''">AND U_NAME LIKE CONCAT('%',#{uName},'%')</if>
        <if test="whIdx != null and whIdx != ''">AND WH_IDX LIKE CONCAT('%',#{whIdx},'%')</if>
    </sql>

    <select id="selectLocationDatatable" resultType="map">
        SELECT
            LOC_IDX,
            WH_IDX,
            WH_NAME,
            LOC_TYPE,
            LOC_CODE,
            LOC_FORM,
            LOC_ZONE,
            LOC_COLUMN,
            LOC_ROW,
            LOC_BARCODE,
            U_NAME
        FROM
            LOCATION
                LEFT JOIN WAREHOUSE ON LOC_WH_IDX = WH_IDX
                LEFT JOIN USER ON LOC_U_IDX = U_IDX
        <where>
            <include refid="includeLocationDatatable"></include>
        </where>
        <if test="length != -1">
            LIMIT #{start},#{length}
        </if>
    </select>

    <select id="countLocationDatatable" resultType="long">
        SELECT
            COUNT(DISTINCT(LOC_IDX))
        FROM
            LOCATION
                LEFT JOIN WAREHOUSE ON LOC_WH_IDX = WH_IDX
                LEFT JOIN USER ON LOC_U_IDX = U_IDX
        <where>
            <include refid="includeLocationDatatable"></include>
        </where>
    </select>

    <update id="changeAllLocType">
        UPDATE
            LOCATION
        SET
            LOC_TYPE = #{locType}
        WHERE
            <foreach collection="locIdxs" open="LOC_IDX IN (" separator="," close=")" item="item">
                #{item}
            </foreach>
    </update>

    <insert id="insertLocationByExcel" parameterType="List">
        INSERT INTO
            LOCATION (LOC_WH_IDX, LOC_CODE, LOC_TYPE, LOC_FORM, LOC_ZONE, LOC_ROW, LOC_COLUMN)
        VALUES
            <foreach collection="list" separator="," item="item">
                (#{item.warehouse.whIdx},
                 #{item.locCode},
                 #{item.locType},
                 #{item.locForm},
                 #{item.locZone},
                 #{item.locRow},
                 #{item.locColumn})
            </foreach>
    </insert>

    <select id="countGoodsInWarehouse" resultType="int">
        SELECT
            COUNT(DISTINCT(G_IDX))
        FROM
            GOODS,
            WAREHOUSE
                LEFT JOIN LOCATION ON LOC_WH_IDX = WH_IDX
        WHERE
            G_LOC_IDX = LOC_IDX
            AND WH_IDX = #{whIdx}
    </select>

    <select id="countGoodsInLocation" resultType="int">
        SELECT
            COUNT(DISTINCT(G_IDX))
        FROM
            GOODS, LOCATION
        WHERE
            G_LOC_IDX = LOC_IDX
            AND LOC_IDX = #{locIdx}
    </select>
</mapper>