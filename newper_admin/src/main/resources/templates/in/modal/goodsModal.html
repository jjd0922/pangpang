<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<div class="modal" tabindex="-1" role="dialog" id="goodsModal">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">자산정보확정</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
               <div class="col-lg-12" id="goodsDiv">
                    <form id="goodsModalForm">
                        <div class="card mb-1">
                            <div class="card-body popup-contents mb-1">
                                <fieldset class="mb-0">
                                    <legend class="">1. 자산정보</legend>
                                    <div class="row">
                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">상품코드</span>
                                                    </span>
                                                    <input type="text" class="form-control" name="pIdx" id="pIdx" readonly>
                                                    <input type="hidden" name="cgIdx">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">상품명</span>
                                                    </span>
                                                    <input type="text" class="form-control" id="pName" readonly>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">자산코드</span>
                                                    </span>
                                                    <input type="text" class="form-control" name="gIdx" id="gIdx" readonly>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">자산바코드코드</span>
                                                    </span>
                                                    <input type="text" class="form-control" name="gBarcode" id="gBarcode" readonly>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">IMEI</span>
                                                    </span>
                                                    <input type="text" class="form-control" name="gImei" id="gImei" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>

                                <fieldset class="mt-3">
                                    <legend class="">2. 예상비용</legend>
                                    <div class="row">
                                        <table class="table">
                                            <thead>
                                            <tr>
                                                <th>공정구분</th>
                                                <th>예상공정항목</th>
                                                <th>예상비용</th>
                                                <th>진행여부</th>
                                            </tr>
                                            </thead>
                                            <tbody id="checkProcessTbody"></tbody>
                                        </table>
                                    </div>
                                </fieldset>

                                <fieldset class="mt-3">
                                    <legend>3. 상품 SPEC정보<a href="javascript: setSpec5();" class="badge badge-sm badge-primary ml-1">판매SPEC 자동세팅</a></legend>
                                    <div class="row">
                                        <table class="table">
                                            <thead>
                                            <tr>
                                                <th>SPEC명</th>
                                                <th>입고SPEC(확정)</th>
                                                <th>가공SPEC(예정)</th>
                                                <th>가공SPEC비용</th>
                                                <th>판매SPEC(확정)</th>
                                            </tr>
                                            </thead>
                                            <tbody id="goodsSpec">

                                            </tbody>
                                        </table>
                                    </div>
                                </fieldset>



                                <fieldset class="mt-3">
                                    <legend class="">4. 옵션</legend>
                                    <div class="row">
                                        <!-- 입력필드 -->
                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">옵션1</span>
                                                    </span>
                                                    <select name="goodsOption" id="goodsOption1" class="form-control"></select>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 입력필드 -->
                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">옵션2</span>
                                                    </span>
                                                    <select name="goodsOption" id="goodsOption2" class="form-control"></select>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- 입력필드 -->
                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">옵션3</span>
                                                    </span>
                                                    <select name="goodsOption" id="goodsOption3" class="form-control"></select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>

                                <fieldset class="mt-3">
                                    <legend>5. 첨부파일</legend>
                                    <div class="row">
                                        <!-- 입력필드 -->
                                        <div class="col-sm-12 col-md-12">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">첨부파일</span>
                                                    </span>
                                                    <input type="file" class="form-control" name="gFile" multiple>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>

                                <fieldset class="mt-3">
                                    <legend>6. 메모</legend>
                                    <div class="row">
                                        <!-- 입력필드 -->
                                        <div class="col-sm-12 col-md-12">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">메모</span>
                                                    </span>
                                                    <input type="text" id="gMemo" name="gMemo" class="form-control"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>

                                <fieldset class="mt-3">
                                    <legend>7. 자산재고</legend>
                                    <div class="row">
                                        <!-- 입력필드 -->
                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">판매처</span>
                                                    </span>
                                                    <input type="text" id="gVendor" name="gVendor" class="form-control"/>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 입력필드 -->
                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">등급</span>
                                                    </span>
                                                    <select name="gRank" id="gRank" class="form-control">
                                                        <option th:each="opt: ${T(com.newper.constant.GRank).values()}" th:text="${opt.option}" th:value="${opt.name()}"></option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Footer -->
            <div class="navbar navbar-dark border-bottom-0 border-top d-flex justify-content-between py-2">
                <button th:if="${ig?.po?.poState.name() != 'COMPLETE'}" type="button" class="btn btn-sm btn-secondary ml-1" onclick="goodsInfoComplete();">저장</button>
            </div>
            <!-- /footer -->
        </div>
    </div>
</div>

<script th:inline="javascript">
    function goodsInfoComplete() {
        $.ajax({
            type: "POST",
            url:"/in/goodsInfoComplete.ajax",
            processData: false,
            contentType: false,
            data: new FormData($('#goodsModalForm')[0]),
            async: false,
            success : function(result){
                location.reload();
            }
        });

    }

    function setSpec5() {
        $.each($('input[name=specName]'), function (index, value) {
            if ($('#pSpec1'+index).val() != '') {
                $('#sellSpec2_'+index).val($('#pSpec1_'+index).val());
            } else {
                $('#sellSpec2_'+index).val($('#inSpec2'+index).val());
            }
        });
    }

    function setGoodsSpec(dataMap)  {
        var gJson = JSON.parse(dataMap.G_JSON);
        if(dataMap.CATE_SPEC_LIST != null){
            var specList = JSON.parse(dataMap.CATE_SPEC_LIST);

            var inSpec2 = listNullCheck(gJson.inSpec2, specList.length);
            var pSpec1 = listNullCheck(gJson.pSpec1, specList.length);
            var psCost = listNullCheck(gJson.psCost, specList.length);
            var sellSpec2 = listNullCheck(gJson.sellSpec2, specList.length);

            $('#goodsSpec').empty();
            for (var i = 0; i < specList.length; i++) {
                var specTr
                    ='<tr>'
                    +'<td id="specList'+i+'" class="specListTd">'+specList[i]+'</td>'
                    +'<input type="hidden" name="specName" value="' + specList[i] + '">'
                    +'<td><input type="text" specList="'+i+'" id="inSpec2_'+i+'" class="form-control" value="'+inSpec2[i]+'" readonly></td>'
                    +'<td><input type="text" specList="'+i+'" id="pSpec1_'+i+'" name="pSpec1" class="form-control" value="'+pSpec1[i]+'"></td>'
                    +'<td><input type="text" id="psCost_'+i+'" name="psCost" class="form-control" value="'+psCost[i]+'"></td>'
                    +'<td><input type="text" specList="'+i+'" id="sellSpec2_'+i+'" name="sellSpec2" class="form-control" value="'+sellSpec2[i]+'"></td>'
                    +'</tr>';

                $('#goodsSpec').append(specTr);
            }

            var specListTd = $('.specListTd');
            for (var i = 0; i < specListTd.length; i++) {
                $.ajax({
                    type: "GET",
                    url:"/goods/specList.ajax?speclName=" + specListTd[i].innerHTML,
                    async:false,
                    success : function(result){
                        $('input[specList='+i+']').autocomplete({
                            source: result
                            ,minLength: 0
                        });
                    }
                });
            }
        }
    }

    function setGoods(gIdx) {
        var dataMap;
        $.ajax({
            url: '/goods/selectGoods.ajax',
            type: 'POST',
            data: {"gIdx" : gIdx},
            async: false,
            success(data) {
                dataMap = data;
            }
        });

        // 상품 & 자산 정보 세팅
        $('#pIdx').val(dataMap.P_IDX);
        $('#pName').val(dataMap.P_NAME);
        $('#gIdx').val(dataMap.G_IDX)
        $('#gBarcode').val(dataMap.G_BARCODE);
        $('#gImei').val(dataMap.G_IMEI);
        $('input[name=cgIdx]').val(dataMap.CGS_CG_IDX)


        $('input[name=gMemo]').val(dataMap.G_MEMO);

        // 상품 스펙 정보
        setGoodsSpec(dataMap);

        // 예상비용
        setProcessNeed()

        // 옵션
        var options = JSON.parse(dataMap.G_OPTION);
        setGoodsOption(options)


        // 첨부파일
        // var text = '';
        // $.each(gJson.gFile, function(index, value) {
        //     text += '<a href="javascript: fileDownload(\''+gJson.gFile[index]+'\',\''+gJson.gFileName[index]+'\')" className="badge badge-sm badge-primary ml-1">'+gJson.gFileName[index]+'</a>'
        // });
        // $('#fileSpan').append(text);


        // 메모
        $('#gMemo').val(dataMap.G_MEMO);

        // 자산재고
        $('#gVendor').val(dataMap.G_VENDOR);
        $('#gRank option[value='+dataMap.G_RANK+']').prop('selected', 'selected').change();
    }

    function setProcessNeed() {
        $('#checkProcessTbody').empty();
        var pnProcess = [[${T(com.newper.constant.PnProcess).values()}]];
        var option = '';
        for (var i = 0; i < pnProcess.length; i++) {
            option += '<option value="'+pnProcess[i]+'">'+pnProcess[i]+'</option>';
        }


        for (var i = 0; i < 3; i++) {
            var type = '';
            var type_kor = '';
            var type_name = '';
            if (i == 0) {type = "PAINT"; type_kor = "도색"; type_name="paint"}
            else if (i == 1) {type = "FIX"; type_kor = "수리"; type_name="fix"}
            else {type = "PROCESS"; type_kor = "가공"; type_name="process"}



            $.ajax({
                type: "POST",
                url:"/process/selectProcessNeed.ajax",
                data: {
                    "gIdx":$('#gIdx').val(),
                    "cgIdx":$('#cgIdx').val(),
                    "pnType":type
                },
                async:false,
                success : function(result){
                    var html = ''
                    var content = '';
                    var cost = '';
                    var process = '';
                    if (result != '') {
                        content = result.PN_CONTENT;
                        cost = result.PN_EXPECTED_COST;
                        process = result.PN_PROCESS;
                    }

                    if (type == 'PROCESS' && result.PN_JSON != null) {
                        setProcessCost(result.PN_JSON);
                    }

                    html = '<tr>' +
                        '<td>'+type_kor+'</td>'+
                        '<td><input type="text" name="'+type_name+'Memo" class="form-control" value="'+content+'"></td>' +
                        '<td><input type="text" name="'+type_name+'Cost" class="form-control" value="'+cost+'"></td>' +
                        '<td>' +
                            '<select name="'+type_name+'Process" class="form-control">' +
                                option
                            '</select>' +
                        '</td>'
                        '</tr>'

                    $('#checkProcessTbody').append(html);
                    $('select[name='+type_name+'Process] option[value="'+process+'"]').prop("selected",true);
                }
            });
        }
    }

    function setProcessCost(data) {
        var json = JSON.parse(data);
        $.each(json.psCost, function (index, value) {
            $('#psCost_'+index).val(value);
        })
    }

    function setGoodsOption(options) {
        for (var i = 0; i < 3; i++) {
            var num = parseInt(i) + 1;
            $('#goodsOption' + num).empty();
            $('#goodsOption' + num).append('<option value="">없음</option>');
        }

        for (var i = 0; i < options.length; i++) {
            var text = '';
            for (var j = 0; j < options[i].values.length; j++) {
                text += '<option value="' + options[i].title + ':' + options[i].values[j] + '">' + options[i].values[j] +'</option>'
            }
            var num = parseInt(i) + 1;
            $('#goodsOption' + num).empty();
            $('#goodsOption' + num).append(text);
        }
    }

    function openGoodsModal (gIdx) {
        setGoods(gIdx);
        $('#goodsModal').modal('show');
    }
</script>
</html>
