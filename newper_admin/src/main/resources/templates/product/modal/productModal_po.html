<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<div class="modal" tabindex="-1" role="dialog" id="productModal">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">상품코드 검색</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="productModalForm" onkeypress="if(event.keyCode==13){searchProductModal();return false;}">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-body popup-contents">
                                <fieldset class="mb-0">
                                    <legend class="">상품코드 검색</legend>
                                    <div class="row">
                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">상품코드</span>
                                                    </span>
                                                    <input type="text" class="form-control" name="pIdx" placeholder="검색">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">상품명</span>
                                                    </span>
                                                    <input type="text" class="form-control" name="pName" placeholder="검색">
                                                </div>
                                            </div>
                                        </div>


                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">브랜드</span>
                                                    </span>
                                                    <input type="text" class="form-control" name="pBrand" placeholder="검색">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">카테고리 대분류</span>
                                                    </span>
                                                    <select name="category1" data-placeholder="다중선택가능" class="form-control">
                                                        <option></option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">카테고리 중분류</span>
                                                    </span>
                                                    <select name="category2" data-placeholder="다중선택가능" class="form-control">
                                                        <option></option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <span class="input-group-prepend">
                                                        <span class="input-group-text">카테고리 소분류</span>
                                                    </span>
                                                    <select name="category3" data-placeholder="다중선택가능" class="form-control">
                                                        <option></option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                            <div class="card-footer bg-white d-flex justify-content-end align-items-center">
                                <button type="button" class="btn btn-sm btn-secondary ml-1" onclick="searchProductModal()">
                                    <i class="icon-search4 mr-1"></i>조회
                                </button>
                            </div>

                        </div>
                    </div>
                </form>
                <table class="table" id="productModalTable">
                </table>
            </div>
            <!-- content area -->
            <div id="productPoDiv" class="content container-fluid" style="display: none;">
                <div class="row">
                    <div class="col-lg-12">
                        <form id="productModalPoForm">
                            <div class="card">
                                <div class="card-body popup-contents">
                                    <!-- 타이틀 -->
                                    <fieldset class="mb-0">
                                        <legend class="">1. 상품 구매 정보</legend>
                                        <div class="row">
                                            <!-- 입력필드 -->
                                            <div class="col-sm-12 col-md-6">
                                                <div class="form-group">
                                                    <div class="input-group">
                                                        <span class="input-group-prepend">
                                                            <span class="input-group-text">매입수량</span>
                                                        </span>
                                                        <input type="text" id="ppCount" class="form-control" placeholder="입력">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 입력필드 -->
                                            <div class="col-sm-12 col-md-6">
                                                <div class="form-group">
                                                    <div class="input-group">
                                                        <span class="input-group-prepend">
                                                            <span class="input-group-text">구매단가<br>(실매입가)</span>
                                                        </span>
                                                        <input type="text" id="ppCost" class="form-control" placeholder="입력">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 입력필드 -->
                                            <div class="col-sm-12 col-md-6">
                                                <div class="form-group">
                                                    <div class="input-group">
                                                        <span class="input-group-prepend">
                                                            <span class="input-group-text">판매단가</span>
                                                        </span>
                                                        <input type="text" id="ppSellCost" class="form-control" placeholder="입력">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 입력필드 -->
                                            <div class="col-sm-12 col-md-6">
                                                <div class="form-group">
                                                    <div class="input-group">
                                                        <span class="input-group-prepend">
                                                            <span class="input-group-text">외부상품코드<br>(aj자산코드)</span>
                                                        </span>
                                                        <input type="text" id="ajCode" class="form-control" placeholder="입력">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 입력필드 -->
                                            <div class="col-sm-12 col-md-6">
                                                <div class="form-group">
                                                    <div class="input-group">
                                                        <span class="input-group-prepend">
                                                            <span class="input-group-text">목표수익률</span>
                                                        </span>
                                                        <input type="text" id="ppProfitTarget" class="form-control" placeholder="입력">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </fieldset>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-body popup-contents">
                                    <!-- 타이틀 -->
                                    <fieldset class="mb-0">
                                        <legend class="">2. 예상비용</legend>
                                        <div class="row">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>공정구분</th>
                                                        <th>예상공정항목</th>
                                                        <th>예상비용</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>도색</td>
                                                        <td><input type="text" id="paintMemo"></td>
                                                        <td><input type="text" id="paintCost"></td>
                                                    </tr>
                                                    <tr>
                                                        <td>수리</td>
                                                        <td><input type="text" id="fixMemo"></td>
                                                        <td><input type="text" id="fixCost"></td>
                                                    </tr>
                                                    <tr>
                                                        <td>가공</td>
                                                        <td><input type="text" id="processMemo"></td>
                                                        <td><input type="text" id="processCost"></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </fieldset>
                                    <!-- 타이틀 구분 끝-->
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-body popup-contents">
                                    <!-- 타이틀 -->
                                    <fieldset class="mb-0">
                                        <legend class="">3. 상품 SPEC정보</legend>
                                        <div class="row">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>SPEC명</th>
                                                        <th>입고SPEC(예정)</th>
                                                        <th>판매SPEC(예정)</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="poModalProductSpecList">

                                                </tbody>
                                            </table>
                                        </div>
                                    </fieldset>
                                    <!-- 타이틀 구분 끝-->
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-body popup-contents">
                                    <!-- 타이틀 -->
                                    <fieldset class="mb-0">
                                        <legend class="">4. 옵션</legend>
                                        <div class="row">
                                            <!-- 입력필드 -->
                                            <div class="col-sm-12 col-md-6">
                                                <div class="form-group">
                                                    <div class="input-group">
                                                        <span class="input-group-prepend">
                                                            <span class="input-group-text">옵션1</span>
                                                        </span>
                                                        <select id="productOption1" class="form-control"></select>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 입력필드 -->
                                            <div class="col-sm-12 col-md-6">
                                                <div class="form-group">
                                                    <div class="input-group">
                                                        <span class="input-group-prepend">
                                                            <span class="input-group-text">옵션2</span>
                                                        </span>
                                                        <select id="productOption2" class="form-control"></select>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- 입력필드 -->
                                            <div class="col-sm-12 col-md-6">
                                                <div class="form-group">
                                                    <div class="input-group">
                                                        <span class="input-group-prepend">
                                                            <span class="input-group-text">옵션3</span>
                                                        </span>
                                                        <select id="productOption3" class="form-control"></select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </fieldset>
                                </div>
                            </div>
                        </form>
                        <!-- #regiForm end -->
                    </div>
                </div>
            </div>
            <!-- /content area -->
            <!-- Footer -->
            <div class="navbar navbar-dark border-bottom-0 border-top d-flex justify-content-between py-2">
                <button type="button" class="btn btn-sm btn-secondary ml-1" id="setBtnProductPoModal" style="display: none">상품세팅</button>
            </div>
            <!-- /footer -->
        </div>
    </div>
</div>

<script th:inline="javascript">
    function priceSetting(row) {
        var totalAmount = 0;
        var totalSell = 0;
        var poSellProfit = 0;
        $.each($('input[name=poProductSellPrice]'), function (index, value){
            var buy = $('#poProductCost_' + row).val();
            var sell =  $('#poProductSellPrice_' + row).val();
            var count = $('#poProductCount_' + row).val();

            var paint = $('#poProductPaint_' + row).val();
            var process = $('#poProductProcess_' + row).val();
            var fix = $('#poProductFix_' + row).val();

            console.log(buy);
            console.log(sell);
            console.log(count);
            console.log(paint);
            console.log(process);
            console.log(fix);

            // 예상판매가 총액
            $('#poProductSellPriceTotal_' + row).text(comma(sell * count));

            // 총이익 판매예상액-매입원가(제품매입원가+공정비용)
            var totalProfit = (sell * count) - ((parseInt(buy) + parseInt(fix) + parseInt(process) + parseInt(paint)) * count);
            $('#totalProfit_' + row).text(comma(totalProfit));

            // 수익률 수익액/매입원가(제품매입원가+공정비용)*100
            var profitPer = totalProfit/((parseInt(buy) + parseInt(fix) + parseInt(process) + parseInt(paint)) * count) * 100
            $('#profitPer_' + row).text(Math.round(profitPer) + '%');



            totalSell += sell * count
            totalAmount += buy * count;
            poSellProfit += profitPer

            // 생산원가율 원가 / 매출총액 * 100
            var buy_total_product = buy * count;
            var sell_total_product = sell * count;
            var totalPer = buy_total_product / sell_total_product * 100

            $('#buy_per_' + row).text(Math.round(totalPer) + '%');
        });

        $('input[name=poTotalAmount]').val(comma(totalAmount));
        $('input[name=poSellTotalAmount]').val(comma(totalSell));

        var len = $('input[name=poProductSellPrice]').length;
        $('input[name=poSellProfit]').val(Math.round(poSellProfit/len));
    }

    function productPoDelete (pIdx) {
        $('.productPoTr_' + pIdx).remove();
        priceSetting();
    }

    function settingProduct (id, rowIdx) {
        var dataMap=getDatatablemap(id, rowIdx);

        var row = $('.poProductTr').length;

        var ppCount = $('#ppCount').val();
        if (ppCount == '') {
            alert('매입수량을 입력해 주세요.');
            return false;
        }

        var ppCost = $('#ppCost').val();
        if (ppCost == '') {
            alert('구매단가를 입력해 주세요.');
            return false;
        }

        var ppSellCost = $('#ppSellCost').val();
        if (ppSellCost == '') {
            alert('판매단가를 입력해 주세요.');
            return false;
        }

        var ppProfitTarget = $('#ppProfitTarget').val();
        if (ppProfitTarget == '') {
            alert('목표수익률을 입력해 주세요.');
            return false;
        }

        var paintCost = $('#paintCost').val();
        if (paintCost == '') {
            alert('예상비용 도색 부분을 확인해주세요.');
            return false;
        }

        var fixCost = $('#fixCost').val();
        if (fixCost == '') {
            alert('예상비용 수리 부분을 확인해주세요.');
            return false;
        }

        var processCost = $('#processCost').val();
        if (processCost == '') {
            alert('예상비용 가공 부분을 확인해주세요.');
            return false;
        }

        var spec_check = 0;
        $.each($('input[name=ppSpec1]'), function (index, value) {
            if($(this).val() == '') {
                alert('상품 예상 입고SPEC 정보를 확인해주세요.');
                spec_check = 1;
                return false;
            }

            var ppSpec2 = $(this).parent().next().children('input').val();
            if(ppSpec2 == '') {
                alert('상품 예상 판매SPEC 정보를 확인해주세요.');
                spec_check = 1;
                return false;
            }
        });

        if (spec_check == 1) {
            return false;
        }

        $('#productModal').modal('hide');
        $('#productPoDiv').css('display', 'none');
        $('#setBtnProductPoModal').css('display', 'none')
        var buy_spec = '';
        var sell_spec = '';
        $.each($('.specListTd'), function (index, value) {
            buy_spec += $(this).text() + ':' + $(this).siblings('td').children('input[name=ppSpec1]').val() + '/';
            sell_spec += $(this).text() + ':' + $(this).siblings('td').children('input[name=ppSpec2]').val() + '/';
        });

        buy_spec = buy_spec.slice(0, -1);
        sell_spec = sell_spec.slice(0, -1);


        var product5 = '<tr class="productPoTr_' + row + ' poProductTr">';
        product5 += '<td>' + dataMap.P_IDX + '</td>'
        product5 += '<td>' + $('#ajCode').val() + '</td>';
        product5 += '<input type="hidden" name="poProductMemo" value="' + $('#ajCode').val() + '">'
        product5 += '<td>' + dataMap.P_NAME + '</td>';
        product5 += '<td>' + dataMap.BRAND_NAME + '</td>';
        product5 += '<td>' + $('#productOption1 option:selected').val() + '</td>';
        product5 += '<input type="hidden" name="poProductOption1" value="' + $('#productOption1 option:selected').val() + '">';
        product5 += '<td>' + $('#productOption2 option:selected').val() + '</td>';
        product5 += '<input type="hidden" name="poProductOption2" value="' + $('#productOption2 option:selected').val() + '">';
        product5 += '<td>' + $('#productOption3 option:selected').val() + '</td>';
        product5 += '<input type="hidden" name="poProductOption3" value="' + $('#productOption3 option:selected').val() + '">';
        product5 += '<td>' + dataMap.P_COST + '</td>';
        product5 += '<td>' + comma($('#ppCost').val()) + '</td>';
        product5 += '<td>' + comma($('#ppCount').val()) + '</td>';
        product5 += '<td>' + comma($('#ppCost').val() * $('#ppCount').val()) + '</td>';
        product5 += '<td>' + buy_spec + '</td>';
        product5 += '<input type="hidden" name="poProductSpec" value="'+buy_spec+'">'
        product5 += '<td>' + sell_spec + '</td>';
        product5 += '<input type="hidden" name="poProductSpec2" value="'+sell_spec+'">'
        product5 += '<td>' + $('#fixMemo').val() +'/' + comma($('#fixCost').val()) + '</td>';
        product5 += '<td>' + $('#paintMemo').val() +'/' + comma($('#paintCost').val()) + '</td>';
        product5 += '<td>' + $('#processMemo').val() +'/' + comma($('#processCost').val()) + '</td>';
        product5 += '<td><button type="button" class="btn btn-sm btn-secondary ml-1" onclick="productPoDelete(' + row + ')">삭제</button></td>'
        product5 += '</tr>'
        $('#productTbody').append(product5);

        var product6 = '<tr class="productPoTr_' + row + '">';
        product6 += '<td>' + row + '</td>';
        product6 += '<td>' + dataMap.P_NAME + '</td>';
        product6 += '<td>' + $('#ppCount').val() +'</td>';
        product6 += '<td>' + comma($('#processCost').val()) + '</td>';
        product6 += '<td>' + comma($('#fixCost').val()) + '</td>';
        product6 += '<td>' + comma($('#paintCost').val()) + '</td>';
        product6 += '<td>' + comma($('#ppCount').val() * (parseInt($('#processCost').val()) + parseInt($('#paintCost').val()) + parseInt($('#fixCost').val()))) + '</td>';
        product6 += '<td id="buy_per_' + row + '">0%</td>';
        product6 += '<td>' + comma($('#ppCost').val()) + '</td>';
        product6 += '<input type="hidden" id="poProductCost_' + row + '" name="poProductCost" value="' + $('#ppCost').val() + '">'
        product6 += '<input type="hidden" id="poProductCount_' + row + '" name="poProductCount" value="' + $('#ppCount').val() + '">'
        product6 += '<td>' + comma($('#ppCost').val() * $('#ppCount').val()) + '</td>';
        product6 += '<td>' + comma($('#ppSellCost').val()) + '</td>';
        product6 += '<input type="hidden" id="poProductSellPrice_' + row + '" name="poProductSellPrice" value="' + $('#ppSellCost').val() + '">';
        product6 += '<td id="poProductSellPriceTotal_' + row + '">' +  + '</td>';
        product6 += '<td id="totalProfit_' + row + '">' +  + '</td>';
        product6 += '<td id="profitPer_' + row + '">' +  + '</td>';
        product6 += '<td>' + $('#ppProfitTarget').val() + '%</td>';
        product6 += '<input type="hidden" name="poProductProfitTarget" value="' + $('#ppProfitTarget').val() + '">'
        product6 += '<td><button type="button" class="btn btn-sm btn-secondary ml-1" onclick="productPoDelete(' + row + ')">삭제</button></td>'
        product6 += '<input type="hidden" name="poProduct" value="' + dataMap.P_IDX + '">';
        product6 += '<input type="hidden" id="poProductProcess_' + row + '" name="poProductProcess" value="' + $('#processCost').val() + '">';
        product6 += '<input type="hidden" id="poProductFix_' + row + '" name="poProductFix" value="' + $('#fixCost').val() + '">';
        product6 += '<input type="hidden" id="poProductPaint_' + row + '" name="poProductPaint" value="' + $('#paintCost').val() + '">';
        product6 += '<input type="hidden" name="poProductProcessMemo" value="' + $('#processMemo').val() + '">';
        product6 += '<input type="hidden" name="poProductFixMemo" value="' + $('#fixMemo').val() + '">';
        product6 += '<input type="hidden" name="poProductPaintMemo" value="' + $('#paintMemo').val() + '">';
        product6 += '</tr>';
        $('#productTbody2').append(product6);

        priceSetting(row);

        $('#ppCount').val('')
        $('#ppCost').val('');
        $('#ppProfitTarget').val('');
        $('#paintMemo').val('');
        $('#paintCost').val('');
        $('#fixMemo').val('');
        $('#fixCost').val('');
        $('#processMemo').val('');
        $('#processCost').val('');
        $('#ppSellCost').val('');

        $.each($('input[name=ppSpec1]'), function (index, value) {
            $(this).val('');
            $(this).parent().next().children('input').val('');
        });
    }

    function poProductChoose (id, rowIdx) {
        $('#productPoDiv').css('display', 'block');
        $('#setBtnProductPoModal').css('display', 'block');
        var dataMap=getDatatablemap(id, rowIdx);

        $('#setBtnProductPoModal').attr('onclick', 'settingProduct("' + id + '", "' + rowIdx + '")');

        if(dataMap.CATE_SPEC_LIST != null){
            var specList = JSON.parse(dataMap.CATE_SPEC_LIST);
            specList = specList[0].list.split(',');
            $('#poModalProductSpecList').empty();
            for (var i = 0; i < specList.length; i++) {
                var specTr
                        ='<tr>'
                        +'<td id="specList'+i+'" class="specListTd">'+specList[i]+'</td>'
                        +'<td><input type="text" specList="'+i+'" name="ppSpec1" class="form-control"></td>'
                        +'<td><input type="text" specList="'+i+'" name="ppSpec2" class="form-control"></td>'
                        +'</tr>';

                $('#poModalProductSpecList').append(specTr);
            }


            var specListTd = $('.specListTd');
            for (var i = 0; i < specListTd.length; i++) {
                $.ajax({
                    type: "GET",
                    url:"/goods/specList.ajax?specName=" + specListTd[i].innerHTML,
                    async:false,
                    success : function(result){
                        $('input[specList='+i+']').autocomplete({
                             source: result
                            ,minLength: 0
                        });
                    }
                });
            }
        }

        var options = JSON.parse(dataMap.P_OPTION);
        for (var i = 0; i < 3; i++) {
            var num = parseInt(i) + 1;
            $('#productOption' + num).empty();
            $('#productOption' + num).append('<<option value="">없음</option>>');
        }

        for (var i = 0; i < options.length; i++) {
            var text = '';
            for (var j = 0; j < options[i].values.length; j++) {
                text += '<option value="' + options[i].title + ':' + options[i].values[j] + '">' + options[i].values[j] +'</option>'
            }
            var num = parseInt(i) + 1;
            $('#productOption' + num).empty();
            $('#productOption' + num).append(text);
        }
    }

    function openProductModal(){
        $('#productModal').modal('show');
        selectCategoryAjax(null, '1');
        selectProductDataTable();
    }

    function selectCategoryAjax(idx, type) {
        $.ajax({
            type: "POST",
            url:"/product/category/selectCategory.ajax?cateIdx=" + idx,
            dataType:"json",
            success : function(result){
                var text = '<option>선택</option>';

                $.each(result, function (index, value) {
                    text += '<option value="' + value.CATE_IDX + '">' + value.CATE_NAME + '</option>'
                });

                if (type == '1') {
                    $('select[name=category1]').empty();
                    $('select[name=category2]').empty();
                    $('select[name=category3]').empty();
                    $('select[name=category1]').append(text);
                } else if (type == '2') {
                    $('select[name=category2]').empty();
                    $('select[name=category3]').empty();
                    $('select[name=category2]').append(text);
                } else {
                    $('select[name=category3]').empty();
                    $('select[name=category3]').append(text);
                }

            },
            error : function(a, b, c){
                alert(a + b + c);
            }
        });
    }

    <!-- 상품 검색 -->
    function searchProductModal(){
        $('#productModalTable').dataTable().table.page("first").ajax.url("/product/product.dataTable?" + $('#productModalForm').serialize()).load(null, false);
    }

    function selectProductDataTable(){
        destroyDatatable('productModalTable');
        $('#productModalTable').DataTable({
            dom: '<"datatable-header"Bip><"datatable-scroll"t>',
            ordering: false,
            // select: {
            //     style: 'multi',
            //     selector: 'td:first-child'
            // },
            serverSide: true,
            ajax:{
                url:'/product/product.dataTable',
                type:'post'
            },
            columnDefs: [ {
                width: '40px',
                orderable: false,
                autoWidth: false,
                // className: 'select-checkbox',
                targets:   [0]
            },
            {
                width: '40px',
                targets:    [1]
            }],
            "columns" : [
                {'title':'상품코드','data':'P_IDX', 'defaultContent':'', 'render' : function (data, type, full, meta) {
                        return data + '<input type="hidden" id="productSpecList" value="' + full.CATE_SPEC_LIST + '">';
                    }}
                ,{'title':'상품명','data':'P_NAME', 'defaultContent':''}
                ,{'title':'브랜드','data':'BRAND_NAME', 'defaultContent':''}
                ,{'title':'대분류','data':'CATE_NAME1', 'defaultContent':''}
                ,{'title':'기준매입가','data':'P_SELL_PRICE', 'defaultContent':''}
                ,{'title':'선택','data':'P_IDX','defaultContent':'', 'render':function(data,type,full,meta){
                        return '<button type="button" class="btn btn-sm btn-primary ml-1" onclick="poProductChoose(\'' + meta.settings.sTableId + '\' , ' + meta.row + ');">선택</button>'
                    }}

            ]
        });
    }
</script>
</html>
