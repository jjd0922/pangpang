<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.OrdersMapper">
    <select id="selectOrderGsListByCuIdx" resultType="map" parameterType="map">
        SELECT
        O_DATE,
        O_IDX,
        GS_NAME,
        GS_PRICE,
        O_STATE,
        CU_IDX,
        OG_IDX
        FROM

            order_gs
            left join order_gs_group on OGG_IDX=OG_OGG_IDX
            left join orders on O_IDX=OGG_O_IDX
            left join shop_product_option on OG_SPO_IDX=SPO_IDX
            left join goods_stock on SPO_GS_IDX=GS_IDX
            left join customer on O_CU_IDX=CU_IDX
        WHERE
            CU_IDX=#{cuIdx}
            AND O_REAL=1
    </select>
    <select id="selectOrderGsListByAsIdx" resultType="map" parameterType="map">
        SELECT
            O_DATE,
            O_IDX,
            GS_NAME,
            GS_PRICE,
            O_STATE,
            CU_IDX,
            OG_IDX,
            AS_IDX
        FROM
            order_gs
                left join order_gs_group on OGG_IDX=OG_OGG_IDX
                left join orders on O_IDX=OGG_O_IDX
                left join shop_product_option on OG_SPO_IDX=SPO_IDX
                left join goods_stock on SPO_GS_IDX=GS_IDX
                left join customer on O_CU_IDX=CU_IDX
                left join after_service on AS_OG_IDX=OG_IDX
        WHERE
            AS_IDX IS NOT null
            and CU_IDX=#{cuIdx}
             and O_REAL=1
    </select>

    <select id="selectOrderGsListByComIdx" resultType="map" parameterType="map">
        SELECT
            *
        FROM
            orders
            LEFT JOIN order_gs
            on O_IDX=OG_IDX
            LEFT JOIN shop_product_option
            ON OG_SPO_IDX=SPO_IDX
            LEFT JOIN goods_stock
            ON GS_IDX=SPO_GS_IDX
            LEFT JOIN product
            ON GS_P_IDX=P_IDX
            LEFT JOIN company
            ON P_COM_IDX=COM_IDX
        where
            COM_IDX=#{comIdx}
            AND O_NAME=#{oName}
            AND O_PHONE=#{oPhone}

    </select>


    <select id="selectOcodeByPhIdx" resultType="String">
        SELECT O_CODE FROM PAYMENT_HISTORY,PAYMENT,ORDERS
        WHERE PH_PAY_IDX=PAY_IDX
          AND O_PAY_IDX=PAY_IDX
          AND PH_IDX = #{ph_idx}
    </select>
    <select id="selectOrderGsGroupList" resultType="map">
        SELECT
            OGG_SPO, MAX(OGG_CNT) CNT
        FROM ORDER_GS_GROUP, ORDER_GS,ORDERS
        WHERE OG_OGG_IDX=OGG_IDX
          AND OG_O_IDX=O_IDX
          AND O_CODE = #{o_code}
        GROUP BY OGG_IDX
    </select>
    <select id="selectOGGForReview" resultType="map">
        <![CDATA[
            SELECT
                O_IDX,
                OG_IDX,
                OGG_IDX,
                O_DATE,
                O_CODE,
                GS_THUMB_FILE1,
                GS_THUMB_FILE_NAME1,
                OGG_CNT,
                IF(ISNULL(DN_DATE), "", DN_DATE) AS DN_DATE,
                SP_IDX,
                SP_NAME
            FROM
                ORDER_GS_GROUP
                    LEFT JOIN ORDERS ON OGG_O_IDX = O_IDX
                    LEFT JOIN ORDER_GS ON OG_OGG_IDX = OGG_IDX
                    LEFT JOIN DELIVERY_NUM ON DN_OG_IDX = OG_IDX
                    LEFT JOIN SHOP_PRODUCT_OPTION ON OG_SPO_IDX = SPO_IDX
                    LEFT JOIN GOODS_STOCK ON SPO_GS_IDX = GS_IDX
                    LEFT JOIN SHOP_PRODUCT_ADD ON SPO_SPA_IDX = SPA_IDX
                    LEFT JOIN CUSTOMER ON O_CU_IDX = CU_IDX
                    LEFT JOIN SHOP_PRODUCT ON SPA_SP_IDX = SP_IDX
            WHERE
                O_SHOP_IDX = #{shopIdx}
                AND DATEDIFF(NOW(), O_DATE) <= 60
                AND CU_ID = #{cuId}
            ORDER BY O_DATE DESC
            LIMIT
                #{start}, #{length}
        ]]>
    </select>
    <select id="selectOrderAndShopByOggIdx" resultType="map">
        SELECT
            DISTINCT(O_IDX),
            SPA_SP_IDX AS SP_IDX
        FROM
            ORDER_GS_GROUP
                LEFT JOIN ORDERS ON OGG_O_IDX = O_IDX
                LEFT JOIN ORDER_GS ON OG_OGG_IDX = OGG_IDX
                LEFT JOIN SHOP_PRODUCT_OPTION ON OG_SPO_IDX = SPO_IDX
                LEFT JOIN SHOP_PRODUCT_ADD ON SPO_SPA_IDX = SPA_IDX
        WHERE
            OGG_IDX = #{oggIdx}
    </select>
</mapper>