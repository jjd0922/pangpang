<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head th:replace="part/head :: head('주문/결제정보입력')"></head>

<body th:classappend="${@shopComp.getShopDesign()}">
  <div class="page-container">

  <!-- 헤더 카테고리 -->
  <th:block th:replace="part/header :: main-header"></th:block>

  <!-- 헤더 카테고리 모바일 -->
  <th:block th:replace="part/header_mobile :: main-header-mobile"></th:block>

  <!-- 로그인 모달창 -->
  <th:block th:replace="part/modal :: login-modal"></th:block>

  <!--페이지 타이틀-->
  <section id="orderProcess-route" th:insert="part/title :: pageTitle_2('주문 &#183; 결제정보입력')" class="padding-section page-title-padding"></section>

  <form id="ordersForm">
  <section id="order" class="padding-section">
    <div class="container">
      <!--******************** 01.주문정보 **************************-->
      <h2 class="orderPage-title">01. 주문정보</h2>
      <!-- 주문정보 테이블 -->
      <div class="order-info-wrap mo-display-none">
        <!-- 주문정보 테이블 제목 -->
        <ul class="order-header font-xsm">
          <li>상품번호</li>
          <li>상품명</li>
          <li>수량</li>
          <li>판매가</li>
          <li>에누리</li>
          <li>합계</li>
          <li>배송구분</li>
        </ul>
        <!-- 주문정보 상품 리스트 -->
        <ul class="order-item-list">
          <li class="order-item" th:each="sp : ${spMap}" th:if="${sp.key.isSell()}">
            <ul th:each="osDto : ${sp.value}">
              <!-- 상품코드(썸네일) -->
              <li>
                <input type="hidden" th:name="${osDto.val}" th:value="${osDto.cnt}">
                <div class="order-item-thumb">
                  <a href="javascript:;">
                    <img src="https://dummyimage.com/100x100/eeeeee/777777" alt="상품이미지">
                    <p class="font-xsm" th:text="${sp.key.spIdx}">상품코드</p>
                  </a>
                </div>
              </li>
              <!-- 상품명 -->
              <li>
                <div class="order-item-info-wrap">
                  <div>
                    <a href="javascript:;">
                      <h3 class="font-xsm bold" th:text="${sp.key.spName}">분양몰 상품명</h3>
                    </a>
                  </div>
                  <div class="font-xxsm order-item-info">
                    <p th:text="${osDto.getName()}">상품명</p>
                    <p th:each="spo : ${osDto.spoList}" th:text="${spo.spoName}">옵션명</p>
                  </div>
                </div>
              </li>
              <!-- 수량 -->
              <li>
                <p class="font-sm semi-bold"><th:block th:text="${osDto.cnt}"></th:block>개</p>
              </li>
              <!-- 판매가 -->
              <li>
                <p class="font-sm" th:text="${#numbers.formatInteger(osDto.price,1,'COMMA')}">단가<span class="won">원</span></p>
              </li>
              <!-- 에누리 -->
              <li>
                <div class="basket-aenuri">
                  <!-- 에누리 할인 없는 경우는 <i>태그 삭제 -->
                  <i class="aenuri"></i>
                  <p class="font-sm">-6,000<span class="won">원</span></p>
                </div>
              </li>
              <!-- 합계 -->
              <li>
                <p class="font-sm bold" th:text="${#numbers.formatInteger(osDto.getTotalPrice,1,'COMMA')}">합계<span class="won">원</span></p>
              </li>
              <!-- 배송구분 -->
              <li>
                <!-- 뉴퍼마켓 직배송 상품 -->
                <div class="deliveryDivision-title deliveryDivision-title-1"><span>뉴퍼마켓</span> 직배송 상품</div>
                <!-- 협력업체 직배송 상품
                <div class="deliveryDivision-title deliveryDivision-title-2"><span>협력업체</span> 직배송 상품</div> -->
              </li>
            </ul>
          </li>
        </ul>

        <div class="order-total-wrap">
          <!-- 주문 상품 수량 -->
          <div class="order-totalCount">
            <p class="font-lg semi-bold">주문 상품 <span th:text="${totalCnt}"></span>개</p>
          </div>
          <span class="div-line"></span>
          <!-- 주문 상품 금액 -->
          <div class="order-totalPrice">
            <p class="font-lg semi-bold">주문 상품 금액</p>
            <p class="color-blue font-xxlg bold" th:text="${#numbers.formatInteger(totalPrice,1,'COMMA')}">금액<span class="won">원</span></p>
          </div>
        </div>
      </div>

      <!-- 주문정보 (모바일 ver) -->
      <div class="order-info-wrap pc-display-none">
        <!-- 뉴퍼마켓 직배송 상품 -->
        <div>
          <div class="deliveryDivision-title-wrap">
            <div class="deliveryDivision-title deliveryDivision-title-1"><span>뉴퍼마켓</span> 직배송 상품</div>
          </div>
          <!-- 뉴퍼마켓 직배송 상품 리스트 -->
          <ul class="mo-order-item-list pc-display-none">
            <!-- 상품 1 -->
            <li class="mo-order-item">
              <div class="mo-order-item-innerWrap mo-order-item-innerWrap-thumb">
                <!-- 상품번호(썸네일) -->
                <div class="mo-order-item-thumb">
                  <a href="javascript:;">
                    <div class="basket-item-thumb-img">
                      <img src="https://dummyimage.com/125x125/eeeeee/777777" alt="상품이미지">
                    </div>
                    <p class="font-sm">상품번호</p>
                    <p class="font-sm">001762984</p>
                  </a>
                </div>
                <!-- 상품평 -->
                <div class="order-item-info-wrap">
                  <div>
                    <a href="javascript:;">
                      <h3 class="font-sm bold">삼성 노트북 15인치 코어 i5 랩 8G SSD 대용량 듀얼하드 윈도10 (스페이스그레이)</h3>
                    </a>
                  </div>
                  <div class="font-xxsm order-item-info">
                    <p>상품명 : 삼성 노트북 코어 i5 듀얼하드 윈10</p>
                    <p>사이즈 : 15인치</p>
                    <p>컬러 : 스페이스그레이</p>
                  </div>
                  <p class="font-xxsm">AS보증 (기본제공) <span class="color-blue">1년 무상서비스</span></p>
                </div>
              </div>
              <div class="mo-order-item-price-wrap">
                <!-- 수량 -->
                <div class="mo-order-item-innerWrap">
                  <p class="color-grey666">수량</p>
                  <p>1개</p>
                </div>
                <!-- 판매가 -->
                <div class="mo-order-item-innerWrap">
                  <p class="color-grey666">판매가</p>
                  <p>305,000원</p>
                </div>
                <!-- 에누리 -->
                <div class="mo-order-item-innerWrap">
                  <p class="color-grey666">에누리금액</p>
                  <p>-6,000원</p>
                </div>
                <!-- 합계 -->
                <div class="mo-order-item-innerWrap">
                  <p>합계금액</p>
                  <p class="font-xlg bold">299,000<span class="won">원</span></p>
                </div>
              </div>
            </li>
          </ul>
        </div>

        <!-- 협력업체 직배송 상품 -->
        <div>
          <div class="deliveryDivision-title-wrap">
            <div class="deliveryDivision-title deliveryDivision-title-2"><span>협력업체</span> 직배송 상품</div>
          </div>
          <!-- 협력업체 직배송 상품 리스트 -->
          <ul class="mo-order-item-list pc-display-none">
            <!-- 상품 1 -->
            <li class="mo-order-item">
              <div class="mo-order-item-innerWrap mo-order-item-innerWrap-thumb">
                <!-- 상품번호(썸네일) -->
                <div class="mo-order-item-thumb">
                  <a href="javascript:;">
                    <div class="basket-item-thumb-img">
                      <img src="https://dummyimage.com/125x125/eeeeee/777777" alt="상품이미지">
                    </div>
                    <p class="font-sm">상품번호</p>
                    <p class="font-sm">001762984</p>
                  </a>
                </div>
                <!-- 상품평 -->
                <div class="order-item-info-wrap">
                  <div>
                    <a href="javascript:;">
                      <h3 class="font-sm bold">삼성 노트북 15인치 코어 i5 랩 8G SSD 대용량 듀얼하드 윈도10 (스페이스그레이)</h3>
                    </a>
                  </div>
                  <div class="font-xxsm order-item-info">
                    <p>상품명 : 삼성 노트북 코어 i5 듀얼하드 윈10</p>
                    <p>사이즈 : 15인치</p>
                    <p>컬러 : 스페이스그레이</p>
                  </div>
                  <p class="font-xxsm">AS보증 (기본제공) <span class="color-blue">1년 무상서비스</span></p>
                </div>
              </div>
              <div class="mo-order-item-price-wrap">
                <!-- 수량 -->
                <div class="mo-order-item-innerWrap">
                  <p class="color-grey666">수량</p>
                  <p>1개</p>
                </div>
                <!-- 판매가 -->
                <div class="mo-order-item-innerWrap">
                  <p class="color-grey666">판매가</p>
                  <p>305,000원</p>
                </div>
                <!-- 에누리 -->
                <div class="mo-order-item-innerWrap">
                  <p class="color-grey666">에누리금액</p>
                  <p>-6,000원</p>
                </div>
                <!-- 합계 -->
                <div class="mo-order-item-innerWrap">
                  <p>합계금액</p>
                  <p class="font-xlg bold">299,000<span class="won">원</span></p>
                </div>
              </div>
            </li>
          </ul>
        </div>

        <!-- 주문 상품 총 금액 (모바일 ver) -->
        <div class="mo-order-total-wrap pc-display-none">
          <!-- 주문 상품 수량 -->
          <p class="font-lg">주문 상품 <span>1</span>개</p>
          <!-- 주문 상품 금액 -->
          <div class="mo-order-totalPrice">
            <p class="font-lg bold">주문 상품 금액</p>
            <p class="color-blue font-xxlg bold">598,000<span class="won">원</span></p>
          </div>
        </div>

      </div>

      <!--******************** 02.정보입력 ***************************-->
      <h2 class="orderPage-title">02. 정보입력</h2>
      <!-- 주문자 정보  -->
      <ul class="table">
        <!-- 주문자 -->
        <li>
          <div class="table-title">주문자</div>
          <div class="table-content">
            <input type="text" class="form-control" name="oName" th:value="${customer?.cuName}">
          </div>
        </li>
        <!-- 전화번호 -->
        <li>
          <div class="table-title">전화번호</div>
          <div class="table-content">
            <input type="text" class="form-control" name="oTel">
          </div>
        </li>
        <!-- 휴대전화 -->
        <li>
          <div class="table-title">휴대전화</div>
          <div class="table-content">
            <span><input type="text" class="form-control" name="oPhone" th:value="${customer?.cuPhone}"></span>
            <span class="smsGuide">입력하신 휴대전화번호로 주문완료 메세지를 보내드릴까요?</span>
            <div>
                          <span class="radioSet">
                              <input type="radio" name="radio1" id="01" value="01">
                              <label for="01">예</label>
                          </span>
              <span class="radioSet">
                              <input type="radio" name="radio1" id="02" value="02">
                              <label for="02">아니오</label>
                          </span>
            </div>
          </div>
        </li>
        <!-- 이메일 -->
        <li>
          <div class="table-title">이메일</div>
          <div class="table-content">angegs@naver.com</div>
        </li>
        <!-- 주소 -->
        <li>
          <div class="table-title">주소</div>
          <div class="table-content">(152-050) 서울특별시 송파구 법원로 11길 11</div>
        </li>
      </ul>
      <!-- 배송지 정보  -->
      <ul class="table font-xsm">
        <!-- 배송상품 및 수량 -->
        <li>
          <div class="table-title">배송상품 및 수량</div>
          <div class="table-content semi-bold">삼성 노트북 코어i5 램8G SSD 대용량 듀얼하드 윈10 1개</div>
        </li>
        <!-- 배송지 확인 -->
        <li>
          <div class="table-title">배송지 확인</div>
          <div class="table-content addressConfirm">
                      <span class="radioSet">
                          <input type="radio" name="radio2" id="03" value="03">
                          <label for="03">회원정보동일</label>
                      </span>
            <span class="radioSet">
                          <input type="radio" name="radio2" id="04" value="04">
                          <label for="04">직접입력</label>
                      </span>
            <div class="btn btn5">
              <a href="javascript:;">배송지목록</a>
            </div>
          </div>
        </li>
        <!-- 받으시는 분 -->
        <li>
          <div class="table-title">받으시는 분</div>
          <div class="table-content receiver">
            <!-- input : 이름 -->
            <input type="text" id="receiverName" name="receiverName" class="form-control" maxlength="20" title="이름" placeholder="이름"  value="">
            <!-- input : 이메일 -->
            <div class="input-email">
              <label for="email" class="semi-bold">이메일주소&nbsp;&nbsp;</label>
              <input type="text" id="email" name="email" class="form-control" placeholder="이메일">
              <span class="at">@</span>
              <input type="text" id="emailDomain" name="emailDomain" class="form-control">
              <select class="form-control">
                <option value="직접입력">직접입력</option>
                <option value="naver.com">naver.com</option>
                <option value="daum.net">daum.net</option>
                <option value="hotmail.com">hotmail.com</option>
                <option value="nate.com">nate.com</option>
                <option value="yahoo.co.kr">yahoo.co.kr</option>
                <option value="paran.com">paran.com</option>
                <option value="empas.com">empas.com</option>
                <option value="dreamwiz.com">dreamwiz.com</option>
                <option value="lycos.co.kr">lycos.co.kr</option>
                <option value="korea.com">korea.com</option>
                <option value="gmail.com">gmail.com</option>
                <option value="hanmir.com">hanmir.com</option>
              </select>
            </div>
          </div>
        </li>
        <!-- 주소 -->
        <li>
          <div class="table-title">주소</div>
          <div class="table-content">
            <div class="addr-info">
              <div class="addr-input">
                <input type="text" class="form-control" id="k_address1" title="상세주소" readonly="" value="">
                <div class="btn btn5">
                  <a href="javascript:;">우편번호 선택</a>
                </div>
              </div>
              <div class="addr-input">
                <input type="text" title="상세 주소 입력" class="form-control addr-text" readonly="" value="">
                <label for="no-addr">
                  <input type="checkbox" id="no-addr" title="나머지 주소 없음">
                  <p>&nbsp;&nbsp;나머지 주소 없음</p>
                </label>
              </div>
              <div class="addr-input">
                <input type="text" title="나머지 주소 입력" class="form-control addr-text" name="addr2" value="">
                <p>*&nbsp;&nbsp;나머지 주소 입력</p>
              </div>
            </div>
          </div>
        </li>
        <!-- 전화번호 -->
        <li class="table-phone">
          <div class="table-title">전화번호</div>
          <div class="table-content">
            <select class="form-control">
              <option value="없음">없음</option>
              <option value="02">02</option>
              <option value="031">031</option>
              <option value="032">032</option>
            </select>
            <span>&nbsp;-&nbsp;</span>
            <input type="text" id="HpNo2" class="form-control" maxlength="4" name="HpNo2" value="" title="휴대폰번호 중간 네자리">
            <span>&nbsp;-&nbsp;</span>
            <input type="text" id="HpNo3" class="form-control" maxlength="4" name="HpNo3"  value="" title="휴대폰번호 마지막 네자리">
          </div>
        </li>
        <!-- 휴대전화 -->
        <li class="table-phone">
          <div class="table-title">휴대전화</div>
          <div class="table-content">
            <select class="form-control">
              <option value="010">010</option>
              <option value="011">011</option>
              <option value="016">016</option>
              <option value="017">017</option>
              <option value="018">018</option>
              <option value="019">019</option>
            </select>
            <span>&nbsp;-&nbsp;</span>
            <input type="text" id="HpNo2" class="form-control" maxlength="4" name="HpNo2" value="" title="휴대폰번호 중간 네자리">
            <span>&nbsp;-&nbsp;</span>
            <input type="text" id="HpNo3" class="form-control" maxlength="4" name="HpNo3"  value="" title="휴대폰번호 마지막 네자리">
          </div>
        </li>
        <!-- 배송메시지 -->
        <li>
          <div class="table-title">배송메시지</div>
          <div class="table-content">
            <input type="text" class="form-control deliveryMessage" id="deliveryMessage" name="deliveryMessage" maxlength="30" title="배송메세지" placeholder="* 띄어쓰기 포함 30자 이내" value="">
          </div>
        </li>
      </ul>

      <!--******************** 03.할인적용 ***************************-->
      <h2 class="orderPage-title">03. 할인적용</h2>
      <ul class="table font-xsm">
        <li>
          <div class="table-title">쿠폰적용</div>
          <div class="table-content verticalAlign saleCoupon">
            <p>할인쿠폰을 사용하실 수 있습니다. (할인쿠폰의 경우 1개 상품만 적용가능합니다)</p>
            <div class="coupon-group">
              <div class="btn btn5">
                <a href="javascript:;"><i class="check"></i>쿠폰적용하기</a>
              </div>
              <i class="saleCoupon-icon"></i>
            </div>
          </div>
        </li>
        <!-- 적립금 및 예치금 사용 -->
        <li>
          <div class="table-title">적립금 및 예치금 사용</div>
          <div class="table-content verticalAlign point-wrap">
            <!-- 적립금 -->
            <div class="point">
              <div>
                <div>
                  <input type="radio" id="pointCheck1" name="radio3" value="">
                  <label for="pointCheck1">적립금</label>
                </div>
                <input type="number" id="point1" name="" class="form-control" maxlength="10" title="적립금" value="" oninput="maxLengthCheck(this)">
              </div>
              <p>사용가능&nbsp;&nbsp;<span>806,060</span>원</p>
            </div>
            <!-- 예치금 -->
            <div class="point">
              <div>
                <div>
                  <input type="radio" id="pointCheck2" name="radio3" value="">
                  <label for="pointCheck2">예치금</label>
                </div>
                <input type="number" id="point2" name="" class="form-control" maxlength="10" title="적립금" value="" oninput="maxLengthCheck(this)">
              </div>
              <p>사용가능&nbsp;&nbsp;<span>76,060</span>원</p>
            </div>
            <p><span class="font-sm">※&nbsp;</span>적립금을 사용하시는 경우, 차액은 신용카드 결제만 가능합니다.</p>
          </div>
        </li>
      </ul>

      <!--******************** 04.결제수단 ***************************-->
      <h2 class="orderPage-title">04. 결제수단</h2>
      <ul class="table font-xsm">
        <!-- 일반결제 -->
        <li>
          <div class="table-title">일반결제</div>
          <div class="table-content verticalAlign generalPayment">
            <div>
              <div th:each="methodMap: ${payNormalList}">
                <label style="cursor: pointer;">
                  <input type="radio" name="ipm_idx" th:value="${methodMap.IPM_IDX}">
                  <th:block th:text="${methodMap.IPM_NAME}"></th:block>
                </label>
              </div>
            </div>
            <p><span class="font-sm">※&nbsp;</span>신용카드의 경우, 국세청에 자동 등록이 되기 때문에 현금영수증 또는 세금계산서 발행이 불가합니다. (부가가치세법 제 32조의 제3항, 동법 시행령 제57조 제2항)</p>
          </div>
        </li>
        <!-- 간편결제 -->
        <li>
          <div class="table-title">간편결제</div>
          <div class="table-content easyPayment">
            <label th:each="easy : ${payEasyList}" style="cursor: pointer;">
              <input type="radio" name="ipm_idx" th:value="${easy.IPM_IDX}">
              <img th:src="${easy.IMG}" th:title="${easy.IPM_NAME}" th:alt="${easy.IPM_NAME}">
            </label>
          </div>
        </li>
      </ul>

      <!-- 버튼 -->
      <div class="order-button-group mo-display-none">
        <div class="btn btn3 order-btn semi-bold">
          <a href="javascript: history.back();">이전으로</a>
        </div>
        <div class="btn btn2 order-btn semi-bold">
          <a href="javascript:payRequest();">결제하기</a>
        </div>
      </div>
    </div>

    <!-- 버튼 (모바일 ver) -->
    <div class="mo-order-button-group pc-display-none">
      <div class="btn semi-bold">
        <a href="javascript: history.back();">이전으로</a>
      </div>
      <div class="btn semi-bold">
        <a href="/orderComplete">결제하기</a>
      </div>
    </div>

    <!-- 배송지 목록 모달창 -->
    <th:block th:replace="part/modal :: addrList-modal"></th:block>

  </section>
  </form>

  <!-- 푸터 -->
  <th:block th:replace="part/footer :: main-footer"></th:block>

  <!-- 플로팅 -->
  <th:block th:replace="part/floating :: main-floating"></th:block>

  <!--js-->
  <th:block th:replace="part/js"></th:block>
  </div>

<script th:src="@{/js/iamport.payment-1.1.8.js}"></script>
<script>
  //이중 클릭 방지
  var payRequestAvailable = true;
  //결제팝업
  function payRequest(){
    if(payRequestAvailable){
      payRequestAvailable = false;
      $.ajax({
        url:'/orders/iamport/pay.ajax'
        ,type:'post'
        ,data: $('#ordersForm').serialize()
      }).done(function(res){
        var redirect_url = location.origin+'/orders/result/'+res.data.req.merchant_uid;
        res.data.m_redirect_url=redirect_url;

        var IMP = window.IMP;
        IMP.init(res.data.id);
        IMP.request_pay(res.data.req, function (rsp) {

          $.ajax({
            url:'/orders/iamport/result.ajax'
            ,type:'post'
            ,contentType: 'application/json'
            ,data: JSON.stringify(rsp)
            ,async:false
          });

          if(rsp.success){
            //결제 성공 페이지로 이동
            location.href = redirect_url;
          }else{
            alert(rsp.error_msg);
          }

        });

      }).always(function(){
        payRequestAvailable = true;
      });
    }else{
      console.log('not available');
    }
  }
</script>
<script>

</script>
</body>
</html>