<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newper.mapper.EventGroupMapper">
    <sql id="includeEventGroupDatatable">
        WHERE
            SHOP_IDX = EG_SHOP_IDX
            <if test="shopIdx != null and shopIdx != ''">
                AND SHOP_IDX = #{shopIdx}
            </if>
    </sql>
    <select id="selectEventGroupDatatable" resultType="map">
        SELECT
            EG.*
            ,CONCAT(EG.CREATED_DATE," ", EG.CREATED_TIME) CREATED_DATE_TIME
            ,CONCAT(EG.EG_OPEN_DATE," ",EG.EG_OPEN_TIME) EG_OPEN_DATE_TIME
            ,CONCAT(EG.EG_CLOSE_DATE," ",EG.EG_CLOSE_TIME) EG_CLOSE_DATE_TIME

            ,S.SHOP_NAME
            ,S.SHOP_IDX
        FROM
            EVENT_GROUP EG
            ,SHOP S
        <include refid="includeEventGroupDatatable"></include>
    </select>
    <select id="countEventGroupDatatable" resultType="long">
        SELECT
            COUNT(EG.EG_IDX) CNT
        FROM
            EVENT_GROUP EG
            ,SHOP S
        <include refid="includeEventGroupDatatable"></include>
    </select>

    <select id="eventCategoryProductListByEgIdx" resultType="map" parameterType="long">
        SELECT
            SCATE_IDX
             ,SCATE_NAME

             ,EC_IDX

             ,SP_NAME
             ,SP_STATE
             ,SP_IDX
        FROM
            EVENT_SP
                LEFT JOIN event_category ON ESP_EC_IDX = EC_IDX
                LEFT JOIN event_group ON EC_EG_IDX = EG_IDX
           ,SHOP_PRODUCT
           ,CATEGORY
           ,CATEGORY_SHOP_CATEGORY
           ,SHOP_CATEGORY
        WHERE
            ESP_SP_IDX = SP_IDX
          AND SP_CATE_IDX = CATE_IDX
          AND CSC_CATE_IDX = CATE_IDX
          AND CSC_SCATE_IDX = SCATE_IDX
          AND EG_IDX = #{egIdx}
    </select>

    <select id="eventCategoryProductCountListByEgIdx" resultType="map" parameterType="Long">
        SELECT
            IFNULL(COUNT(SCATE_IDX),0) CNT
             ,EC_IDX
        FROM
            EVENT_SP
                LEFT JOIN event_category ON ESP_EC_IDX = EC_IDX
                LEFT JOIN event_group ON EC_EG_IDX = EG_IDX
           ,SHOP_PRODUCT
           ,CATEGORY
           ,CATEGORY_SHOP_CATEGORY
           ,SHOP_CATEGORY
        WHERE
            ESP_SP_IDX = SP_IDX
          AND SP_CATE_IDX = CATE_IDX
          AND CSC_CATE_IDX = CATE_IDX
          AND CSC_SCATE_IDX = SCATE_IDX
          AND EG_IDX = #{egIdx}
        GROUP BY EC_IDX
    </select>
</mapper>
